=====================================================================
* General *
***********

Многие инструменты могут помочь аналитику безопасности или специалисту по реагированию на инциденты в выполнении анализа памяти на потенциально скомпрометированной конечной точке.
Но большинство из них занимаюь много времени.
Часто, когда аналитик проводит сортировку, время имеет существенное значение, и аналитику необходимо выполнить быструю оценку, чтобы определить характер события безопасности.

Именно здесь вступает в дело инструмент FireEye Redline.
Redline по сути предоставит аналитику обзор конечной точки Windows, Linux или macOS.
Используя Redline, вы можете проанализировать потенциально скомпрометированную конечную точку через дамп памяти, включая различные файловые структуры.
С помощью красивого графического пользовательского интерфейса (GUI) вы можете легко обнаружить признаки вредоносной активности.

Вот что вы можете делать с помощью Redline:

    -   Собирать данные реестра (только для хостов Windows)
    -   Собирать запущенные процессы
    -   Собирать образы памяти (до Windows 10)
    -   Собирать историю браузера
    -   Искать подозрительные строки
    -   И многое другое!

Итак, начнем по-порядку

=====================================================================
* Basics *
**********

    +++++++++++++++++++
    + Data Collection +
    +++++++++++++++++++

    Теперь, когда у вас есть обзор Redline, давайте перейдем к этапу сбора данных.
    Существует три способа или варианта сбора данных с помощью Redline:

        1)  Standard Collector
            Этот метод настраивает скрипт на сбор минимального количества данных для анализа.
            Обычно это самый быстрый метод сбора необходимых вам данных. Он занимает всего несколько минут.

        2)  Comprehensive Collector
            Этот метод настраивает скрипт на сбор наибольшего количества данных с вашего хоста для дальнейшего анализа.
            Процесс сбора данных занимает до часа или больше.
            Его выбирают тогда, когда необходим (или предпочитаете) полный анализ системы.

        3)  IOC Search Collector (Windows only)
            Этот метод собирает данные, которые соответствуют индикаторам компрометации (IOC), которые вы создали с помощью редактора IOC.
            Вы выберете этот метод, если хотите запустить сбор данных по известным IOC, которые вы собрали либо с помощью разведки угроз (data feed or narrative report), реагирования на инциденты или анализа вредоносного ПО.
            Вы импортировали их в редактор IOC. 

        //////////////////////////
        /// Standard Collector ///
        //////////////////////////

        Процедура сбора информации с использованием Standard Collector следующая:

            i)      Сперва запускаем программу и выбираем метод (Standard Collector)
            ii)     Затем выбираем тип операционной системы - Windows / OS X / Linux (в нашем случае выберем Windows).
            iii)    В разделе Review Script Configuration нажмите «Edit your script»
                    Это один из важнейших шагов, поскольку вам будет представлен набор данных для выбора, которые нужно собрать с хоста.
                    Будет пять вкладок, какждая из которых собержит свой набор параметров
                        
                        a)  Memory
                            Вы можете настроить скрипт для сбора данных памяти, таких как списки процессов, перечисление драйверов (только для хостов Windows) и обнаружение хуков (версии до Windows 10).
            
                        b)  Disk
                            Здесь вы можете собрать данные о разделах дисков и томах, а также список файлов.
                
                        c)  System
                            Система предоставит вам информацию о машине:

                                -   Информация о машине и операционной системе (ОС)
                                -   Анализ точек восстановления системы (только версии Windows до 10)
                                -   Перечисление ульев реестра (только Windows)
                                -   Получение учетных записей пользователей (только Windows и OS X)
                                -   Получение групп (только OS X)
                                -   Получение кэша предварительной выборки (только Windows)
                
                        d)  Network
                            Вы можете настроить скрипт для сбора сетевой информации и истории браузера, что необходимо при расследовании действий браузера, включая вредоносные загрузки файлов и входящие/исходящие соединения.
                
                        e)  Other
                            С помощью этой опции вы можете собирать данные о различных службах и задачах, запущенных в системе, включая хэши.
            
            iv)     После выбора параметров данных нажмите OK.
                    А затем нажмите «Browse» под «Save Your Collector To» в правом нижнем углу секции «Specifu Collector Location».
                    Это необходимо для определени папки, в которой будет сохранен ваш файл анализа и скрипт для сбора необходимых вам данных.
                    !!! Вы можете выбрать любую папку, которую хотите, но убедитесь, что папка ПУСТАЯ.
            
            v)      Если вы зайдете в папку, то увидите bat-файл под названием "RunRedlineAudit".
                    Это исполняемый скрипт для сбора данных с хоста.
                    Скрипт необходимо запустить от имени администратора, чтобы иметь возможность собирать нужные нам данные.

                    Запуск скрипта откроет окно командной строки; это означает, что скрипт успешно запущен.
                    Оно автоматически закроется, когда процесс сбора данных завершится.
                    !!! Примечание: этот процесс может занять от 15 до 20 минут.
                                    если вы запустите скрипт несколько раз, соглашение об именовании файла анализа увеличится на 1.
                                    Например, если вы запустите скрипт два раза, вы увидите AnalysisSession1 и AnalysisSession2.
            
            vi)     После завершения скрипта вы увидите новый созданный файл - AnalysisSession1 (в папке Sessions) с расширением .mans.
                    Этот файл нам нужен для импорта в Redline для расследования.
                    Просто дважды щелкните по файлу, чтобы импортировать данные аудита.

        ////////////////////////////
        /// IOC Search Collector ///
        ////////////////////////////            

        Давайте подробнее рассмотрим возможности этого типа сборщика.
        Но сначала давайте вспомним, что такое IOC.

        IOC означает «Indicators of Compromise»
        Это артефакты потенциальной компрометации и вторжения на хост в системе или сети, которые вам нужно искать при проведении поиска угроз или реагировании на инциденты.
        IOC могут быть хэшами MD5, SHA1, SHA256, IP-адресом, доменом C2, размером файла, именем файла, путем к файлу, ключом реестра и т. д.

        Одним из замечательных инструментов, которые вы можете использовать, является редактор IOC, созданный FireEye, для создания файлов IOC.
        Вы можете перейти по этой ссылке, чтобы узнать, как использовать редактор IOC: https://fireeye.market/assets/apps/S7cWpi9W//9cb9857f/ug-ioc-editor.pdf.
        !!! Примечание: согласно странице загрузки редактора IOC, Windows 7 является последней официально поддерживаемой операционной системой.
                        Это та же версия, что установлена ​​в прикрепленной виртуальной машине.
                        Есть еще один инструмент под названием от FireEye, который поддерживает Windows 10, на который стоит обратить внимание  -   OpenIOC Editor
        Вы можете создать текстовый файл, содержащий IOC, изменить его и поделиться им с другими людьми в сфере информационной безопасности.

        Для создания IoC файла (файла с индикаторами компроментации) необходимо выполнить ряд шагов:

            i)      Откройте редактор IOC (если у Вас его нет, то его можно скачать тут - https://fireeye.market/apps/S7cWpi9W)
                    *** Весьма неплохую альтернативу можно найти тут - https://fireeye.market/apps/211404 (Open IoC 1.1 Editor)
                
            ii)     Будет необходимо указать место хранения IoC файла
                    !!! Рекомендуется создать новую папку

            iii)    После определения места размещения хранения, переходим к созданию самого IoC файла

                        File  ->  New  ->  Indicator
                
            iv)     Краткое пояснение к появившемуся окну:

                        *   Имя файла IOC           -   произвольное поле, которое можно редактировать по Вашему усмотрению
                        *   Автор                   -   также произвольное поле с свободным редактирование
                        *   GUID/Created/Modified   -   это поля, которые вы НЕ можете редактировать, и редактор IOC заполняет их автоматически.
                        *   Description             -   тут вы можете добавить любую информацию, объясняющую цель файла IOC.
                        *   Add                     -   раздел, где Вы будете создавать индикатор

                    Вот значения раздела ADD, которые Вы можете использовть:

                        *   Item                -   категория индикатора
                        *   AND/OR              -   логичесике операторы
                        *   Properies           -   позволяет указывать значение индикатора и добавлять комментарий
                                                    икона этого раздела, расположена в конце строки ADD (выглядит как рука над документом)
                        *   Mouse Right-Click   -   позволяет изменять, использованный индикатор и/или логический оператор   
                            
                        Пример:
                            OR
                                File Strings — psylog.exe
                                OR
                                    File Strings — RIDEV_INPUTSINK
                                    AND
                                        File MD5 — 791ca706b285b9ae3192a33128e4ecbb
                                        AND
                                            File Size — 35400
            
            v)      После сохранения срзданного IoC файла, закрываем IoC Editor и запускаем Redline
                    Но, теперь выбираем метод сбора - IoC Search Collector

                    IoC Search Collector проигнорирует данные, которые не соответствуют собранному вами IOC.
                    Хотя вы всегда можете выбрать сбор дополнительных данных.
                    Как указано в руководстве пользователя Redline - качество анализа IOC будет зависеть от данных, которые у вас есть в доступном сеансе анализа.
                
            vi)     В появившеся окне указываем папку, где хранится нужный нам инидикатор
                    Если в папке есть IoC файл, то в разделе «Indicators» будут отображены все файлы-нидикаторы из выбранной папки

                    В поле «Indicator Information» будет отображаться краткая информация по выбранному индикатору (индикаторам)
                    Наиболее интресная для нас информация следующая:

                        -   Unsupported Search Terms
                            Эти термины не будут показывать успешных совпадений в Redline, что означает, что Redline не распознает определенные поисковые термины.

                        -   Supported Search Terms
                            Термины, которые Redline будет распознавать и искать.

            vii)    После того, как вы закончите просмотр настроенных IOC, нажмите «Next».
                    Теперь нажмите «Edit your script», чтобы настроить, какие данные будут собираться для анализа.

                    Закончив редактирование сценария, нажмите «ОК».
                    В разделе «Save Your Collector To» нажмите «Browse» и выберите ПУСТУЮ папку, в которой будет сохранен ваш файл анализа вместе с файлом RunRedlineAudit.bat.

            viii)   Запустите файл RunRedlineAudit.bat таким же образом, как и раньше (запуск с правами Администратора)

                    После завершения анализа вы увидите файл .mans (AnalysisSession1 в нашем примере).
                    Дважды щелкните файл, чтобы открыть его в Redline.
                    *** Если Redline не удается автоматически сгенерировать отчет IOC, вы можете вручную сгенерировать его, нажав «Create a New IOC Report» и импортировав свой файл .ioc

                    В отчете могут попадаться и ЛОЖНЫЕ срабатывания, так что не стоит учитывать каждую запись за 100% достоверную информацию
                    Всегда нужно проверять более тщательно
            
        Если Вы хотите использовать IoC уже после того, как были собранны данные, то в самом низу рабочего окна (под колонкой «Analysis»), будет 3 вкладки
        Вам надо выбрать соответсвующую (должна быть центральная)

    +++++++++++++++++++++++++
    + The Redline Interface +
    +++++++++++++++++++++++++

    Для начала, у вас должен быть файл анализа.
    Как правило файлы Redline bvt.n hfcibhtybt *.
    Для загрузки файла Вам нужно дважды щелкните файл <file_name>.mans, и данные будут автоматически импортированы в Redline.
    *** Возможно потребуется некоторое время, чтобы импортировать данные

    После импорта данных вам будет представлено следующее представление:

        -   На левой панели вы увидите различные типы данных анализа
            Здесь вы будете выполнять сбор информации и процесс исследования:

                *)  System Information
                    Здесь вы увидите информацию о машине, BIOS (только Windows), операционной системе, информацию о пользователе и другое.
                
                *)  Processes
                    Процессы будут содержать различные атрибуты, такие как имя процесса, PID, путь, аргументы, родительский процесс, имя пользователя и т. д.
                    При раскрытии вкладки «Processes» будут четыре раздела:
                            
                            i)      Handles (Соеденители)
                                    Соеденители — это связка процесса с объектом или ресурсом в операционной системе Windows.
                                    Операционные системы используют соеденители для ссылки на внутренние объекты, такие как файлы, ключи реестра, ресурсы и т. д.
                            
                            ii)     Memory Sections
                                    Разделы памяти позволят вам исследовать неподписанные разделы памяти, используемые некоторыми процессами.
                                    Многие процессы обычно используют легитимные библиотеки динамической компоновки (DLL), которые будут подписаны.
                                    Это особенно интересно, потому что если вы увидите какие-либо неподписанные DLL, то стоит присмотреться повнимательнее.
                            
                            iii)    Strings
                                    Строки — вы увидите информацию о захваченных (исследуемых) строках.
                            
                            iV)     Ports
                                    Порты — это один из критических разделов, на который следует обратить внимание.
                                    Большинство вредоносных программ часто инициируют исходящие или входящие соединения для связи со своим сервером управления и контроля (C2) для выполнения некоторых вредоносных действий, таких как эксфильтрация данных или захват полезной нагрузки на машину.
                                    В этой ситуации вы можете просмотреть подозрительные соединения с портов и IP-адресов.
                                    !!! Обратите внимание также на системные процессы.
                                        Субъекты угроз любят избегать обнаружения, скрываясь под системными процессами.
                                        Например, explorer.exe или notepad.exe не должны быть в списке процессов с исходящими соединениями.

                *** Также возможно будут и другие важные разделы, на которые вам следует обратить внимание:

                    -   File System
                    -   Registry
                    -   Windows Services
                    -   Users
                    -   Event Logs 
                    -   Tasks (злоумышленники любят создавать запланированные задачи для сохранения)
                    -   ARP Entries
                    -   Route Entries
                    -   Volumes
                    -   История URL-адресов браузера
                    -   История загрузки файлов
                
                *)  Timeline
                    Временная шкала поможет вам лучше понять, когда произошел взлом и какие шаги предпринял злоумышленник для эскалации атаки.
                    Она также будет регистрировать каждое действие с файлом, если он был создан, изменен, модифицирован, к нему был получен доступ.

                    Если вы знаете, когда произошел взлом хоста или подозрительная активность, вы можете использовать «TimeWrinkles™», чтобы отфильтровать временную шкалу только по событиям, которые произошли в это время.

                    TimeCrunches™ помогает сократить избыточный объем данных, которые не имеют значения в табличном представлении.
                    TimeCrunch скроет те же типы событий, которые произошли в течение той же минуты, которую вы указали.
