=====================================================================
* Легенда сценария *
********************

Один из сотрудников (Simon Stark) компании подвергся атаке 13 февраля, после того, как он скачал ZIP-файл по ссылке, полученной в электронном письме
Открыв архив, на его компьютер был загружен вредоносный код, который позволил злоумышленнику установить соединение с С2 сервером
Вам как специалисту отдела DFIR поручено проанализировать содержание данного архива и ответить на поставленные вопросы

В процессе исследования Вы познакомитесь с методологиями, используемыми в криминалистике MFT (главной файловой таблицей).
А также с известными инструментами применяемыми при анализе артефактов MFT для выявления вредоносной активности.
А именно:

    -   MFTECmd
        Используется для анализа MFT-файла

    -   TimeLine Explorer
        Применяется для открытия и анализа результатов анализа MFT, предварительно сохраненных в формате CSV

    -   HxD Editor
        Редактор файлов в шестнадцатеричном формате для восстановления содержимого MFT-файла

=====================================================================
* Задания *
***********

Как и всегда, разбор заданий будет идти по порядку, НО полученные сведения могут перекликаться между заданиями.
Более того, для подтверждения найденной "улики" в одном отчете, необходимо сравнить с данными из другого отчета 
Поэтому НАСТОЯТЕЛЬНО рекомендуется делать записи/пометки

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 1 -  Определить, как назывался ZIP-файл, скачанный по ссылке +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Итак, у нас есть MFT образ диска "С"
    Напомню, MFT (Master File Table) - это "основная таблица файлов", которая является важнейшим компонентом NTFS, и в которой хранятся метаданные для всех файлов и каталогов на томе.

    Для анализа файла $MFT мы воспользуемся одиним из инструментов Эрика Циммермана, используемым для исследования файлов MFT - MFT Explorer (MFTECmd.exe)
    MFTECmd анализирует данные из различных файлов, созданных файловой системой NTFS, таких как $MFT, $Boot и т. д.

    Для использования данной утилиты в командной строке нам необходимо ввести следующую команду:

        PS C:\Users\<user_name>> MFTECmd.exe -f <path-to-$MFT-file> --csv <path-to-save-results-in-csv>
    
    Для просмотра результатов обработки MFTECmd файла MFT можно воспользоваться различными инструментами по анализу CSV-файлов
    Я предпочитаю "TimelineExplorer"

    Так как нам известно, что был скачан файл с расширением ZIP, то в колонке "Extensions" мы печатем ZIP
    
    Файл MFT может содержать данные за большой промежуток времени
    Поэтому, зная временной интервал или начальную дату, с которой происходило событие, мы можем указать ее в колонке "Created0x10"
    Нам известно, что архив был скачан 13 февраля.
    Поэтому, в drop-down menu этой колонки (щелкнув на значек фильтра в праом верхнем углу колонки) сперва выбираем "Is Same Day", а потом конкретную дату

    В итге у нас появиться список записей, где встречаются фалы с расширением ZIP за конкретную дату

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 2 - Определить URL откуда был скачан данный архив +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Выяснив название скачанного архива, мы можем сбросить фильтр по колонке "Extensions" (временной фильтр по колнке "Created0x10" можно пока оставить)
    Но, нам надо будет назначить новый фильтр по колнке "File Name" (можно либо целиком, без расширения; либо уникальное слово из название архива)

    После оплучения новых результатов, Вам надо будет прокрутить экран вправо до колонки "Zone Id Contents"
    Где напротив одной из записей с названием скачаного архива Вы увидите искомый URL
    
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 3 - Определить путь и имя испольнительно вредоносного файла, который подключился к серверу С2 +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Скачаный архив был всего лишь "контейнером", который содержал в себе скрытый файл с вредоносным кодом
    Вот именно этот скрытый файл нам и предстоит найти

    Как правило, на первых этапах будет прослеживаться связь между именем, скачаного архива и расположением вредоносного файла
    Поэтому, нам надо сменить фильтр c колонки "File Name", на колонку "Parent Path"
    В колонке "Parent Path" мы все также будем использовать уникальное слово из названия скачаного архива

    В списке результатов нам надо обращать внимание на:

        1)  События идущие следом или очень близко от времени скачивания архива
        2)  Записи в колонке "Extansion"

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 4 - Определить @timestamp создания файла, который был обнаружен на предыдущем шаге +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Для просмотра времени и даты создания, найденного вредоносного файла, Вам необходимо посмотреть запись по колонке "Created0x30"    

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 5 - Определить шестнадцатеричное смещение (hex offset) найденного вредоносного файла +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Результаты, отображаемые в TimelineExplorer хотя весьма информативны, но не показывают всех деталей
    В данном случае, нам надо определить шестнадцатеричное смещение (hex offset) найденного вредоносного файла, чтобы потом просмотреть содежание этого вредоносного файла в шестнадцатеричной структура файла MFT

    Самый простой способ определить шестнадцатеричное смещение (hex offset) файла - это найту занчение номера записи (колонка "Entry Number") для нужного файла в результатах TimelineExplorer
    Затем умножить это число на 1024.
    Полученный результат - это смещение в десятичном формате (у нас это 23,998,464)
    Поэтому, нам надо перевести его в шестнадцатеричный формат
    Для этого можно использовать калькулятор или следующий пример:

        23,998,464 ÷ 16 = 1,499,904     остаток 0 → последняя цифра 0
        1,499,904 ÷ 16 = 93,744         остаток 0 → ещё 0
        93,744 ÷ 16 = 5,859             остаток 0 → ещё 0
        5,859 ÷ 16 = 366                остаток 3 → цифра 3 (5859-366*16=5859-5956=3)
        366 ÷ 16 = 22                   остаток 14 (E) → E (числу 14 в шестнадцетеричной системе соответствуетбуква "Е")
        22 ÷ 16 = 1                     остаток 6 → 6
        1 ÷ 16 = 0                      остаток 1 → 1

        Собираем в обратном порядке: 0x16E3000
    
    *** В ответе (да и в дальнейшем) 0x мы учитывать не будем, так как это показатель шестнадцатеричной системы

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 6 - Определить IP-фадрес и номер порта С2 сервера +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Немного информации...
        Размер каждой записи MFT составляет 1024 байта.
        Если файл на диске имеет размер меньше 1024 байт, он может быть сохранён непосредственно в самом файле MFT.
        Такие файлы называются резидентными файлами MFT.
        При исследовании файловой системы Windows крайне важно искать любые вредоносные/подозрительные файлы, которые могут находиться в MFT.
        Это позволит обнаружить содержимое вредоносных файлов/скриптов.
    
    Таким образом, нам надо использовать полученный hex offset, чтобы найти IP-адрес и порт командного сервера в шестнадцатеричной структуре MFT файла.
    Для этого нам понадобиться утилита "HxD" (ну или любай другая, позволяющая просматривать содержимое файла в шестнадцатеричном формате)

    Запускаем утилиту и загружаем наш MFT файл
    Затем в меню "Search" выбираем опцию "Go to..." и вводим либо hex offset (16E3000), либо наше десятиричное значение (23998464)
    Результат поиска приведет нас к начальной точки вредоносного файла и нам останется немного прокрутить вниз, пока не увидим его содежимое
    В дебрях содежимого и будет находиться IP-адрес и номер порта С2 сервера
    