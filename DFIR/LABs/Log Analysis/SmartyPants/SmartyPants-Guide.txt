=====================================================================
* Легенда сценария *
********************

Технический директор Forela, Датч, хранит важные файлы в отдельной системе Windows, поскольку доменная среда Forela часто подвергается взлому из-за своей уязвимости в различных отраслях.
24 января 2025 злоумышленник получил доступ к файловому серверу, установил утилиты для своих действий, похитил критически важные файлы, а затем удалил их, сделав их невосстановимыми.
Команда была немедленно проинформирована о попытке вымогательства со стороны злоумышленников, которые теперь требуют деньги.
Вам необходимо быстро провести сортировку, чтобы оценить масштаб инцидента.
*** Несколько дней назад мы включили журналы отладки SmartScreen на всех наших компьютерах для улучшения контроля, следуя рекомендациям исследования безопасности.
    Эти журналы могут предоставить быструю информацию, поэтому обязательно используйте их.

В обзоре данного сценария (под именем SmartyPants), Вам будет предоставлено огромное количество журналов Windows (*.evtx) для анализа.
К счатью нам понядобятся только три из них (а все остальные Вы можете просмотреть самостоятельно), а именно:

    -   Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational

    -   Smartscreen Debug

    -   Security

А также инструментами, которые можно использовать для адаптации журналов *.evtx в удобночитаемый формат *.csv с последующим анализов в специальных приложениях:

    -   EvtxEcmd
        Это инструмент командной строки, который анализирует журналы событий Windows в различных форматах, таких как CSV, JSON, XML и т. д.

    -   TimelineExplorer
        Инструмент на основе графического интерфейса, который функционирует как приложение для фильтрации и навигации данных, чтобы облегчить специалистам по реагированию на инциденты обработку необработанных данных.

    -   EventViewer
        Это инструмент Microsoft Windows для просмотра системных журналов, журналов безопасности и журналов приложений, позволяющий устранять неполадки, оценивать состояние системы и отслеживать события безопасности

=====================================================================
* Задания *
***********

Как и всегда, разбор заданий будет идти по порядку, НО полученные сведения могут перекликаться между заданиями.
Более того, для подтверждения найденной "улики" в одном лог-файле, необходимо сравнить ее с данными из другого лог-файла 
Поэтому НАСТОЯТЕЛЬНО рекомендуется делать записи/пометки

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 1 - Опеределить временную метку RDP входа злоумышленника +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Как мы уже знаем    -   нам предоставили огромное количество журналов событий Windows (*.evtx)
    Просматривать их все (даже если они нужны) через EventViewer крайне не удобно, так как придется делать по одному журналу за раз
    Поэтому, проще и оптимальнее всего прогнать все их через утилиту Эрика Циммермана   -   EvtxECmd, чтобы иметь их все в одном *.csv-файле

    Команда для трансформации целого каталога журналов практически ничем не отличается от трансформации одиночно файла
    Разница только в ключе -d вместо -f
    
        PS C:\Users\<user_name>> .\EvtxECmd.exe -d 'C:\Path\to\the\EVTX\logfile' --csv 'C:\Path\where\results\will\be\stored' --csvf <file_name>.csv

        ИЛИ

        PS C:\Path\to\the\folder\EvtxECmd> .\EvtxECmd.exe -d 'C:\Path\to\the\EVTX\logfile' --csv 'C:\Path\where\results\will\be\stored' --csvf <file_name>.csv

    В результате мы получаем один файл со всеми журнала сразу.
    Открываем файл в TimelineExplorer и наслаждаемся содержимым в стиле "Все включено"
    А для перемещения между журналами внутри файла, нам понадобиться столбец "Channel"

    Для ответа на данный вопрос выбираем журнал "Microsoft-Windows-TerminalServices-RemoteConnectionManager/Operational"
    Далее, если вы знаете номер Event ID, которое отвечает за установку RDP-соединения, тогда фильтруете по номеру
    А если не знаете, то прокручиваете содердимое журнала вправо до столбца "Map Description" и выбираете нужную Вам запись

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 2-9 - Опеределить какие инструменты, для вредоносной деятельности, и когда были скачаны злоумышленником +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Злоумышленник загрузил несколько утилит, которые помогли ему в его диверсионно-вымогательской операции.
    Для определения списка загруженных утилит нам понадобиться журнал   -   "Smartscreen Debug"
    Так что меняем "Channel" на соответствующий

    Если Вы решите просматривать данный журнал через EventViewer, то Вам понядобиться изучать каждое событие через "XML View" вкладки "Details" окна описания события (которое находится подс списком соытий)
    Также Вы можете оптимизировать Ваш поиск в EventViewer посредством ручного редактирования XML Query, через меню "Filter Current Log..."
    Но этот процес потребует времени и навыков, поэтому проще всего воспользоваться TimelineExplorer 

    Выбрав нужный журнал в TimelineExplorer, Вам надо будет прокрутить его вправо до столбца "Payload"
    Затем отфильтровать данный столбец по ключевому слову "isFileSupported"
    И среди полученного результата выбирать нужную запись

    *** Крайне рекомендую прогонять название каждого найденного приложения через Google или VirusTotal, чтобы быть полностью уверенным, что "найденыш" представляет угрозу
    
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 10 - Опеределить когда журнал был изменен/очищен, чтобы скрыть следы присутствия злоумышленника +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Злоумышленник очистил два важных журнала, чтобы замести все следы.

    Для определения когда был очищен журнал (в нашем примере это журнал "Security"), необходимо сперва перейти в этот журнал
    Затем в столбце "Map Description" выбрать фильтр, который содержит значение указываюеще на очистку журнала (что-то вроде "Event Log CLeared")

    Если Вы хотите посмотреть в каких еще журналах присутствую подобные события, то сперва убираем фильтр по столбцу "Channel"
    А затем добавляем фильтр по столбцу "Map Description", содержащий в своем название слово "clear"
