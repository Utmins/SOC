=====================================================================
* Легенда сценария *
********************

Комнада Unit42 из Пало-Альто провела исследование ПО UltraVNC, в ходе которой было обнаружено, что злоумышленники использовали версию UltraVNC с бэкдором для доступа к системам.
А так как UltraVNC — это свободное программное обеспечение для операционной системы Microsoft Windows, использующее протокол VNC для управления удалёнными рабочими столами на других компьютерах.
То, в обзоре данного сценария (под именем Unit42), вы познакомитесь с анализом некоторых событий журнала Sysmon, а именно:

    -   Event ID 1  -   Process Creation
        Это событие регистрирует создание (или выполнение) процесса и предоставляет подробную информацию о нём.

    -   Event ID 2  -   File Creation Time Changed
        Регистрирует изменения времени создания файла, что может указывать на попытку скрыть время создания или изменения файла.

    -   Event ID 3  -   Network Connection
        Это событие регистрирует исходящие сетевые соединения, инициированные процессами, обеспечивая видимость сетевой активности.

    -   Event ID 5  -   Process Termination
        Регистрирует завершение процесса

    -   Event ID 11 -   File Created
        Это событие регистрируется при создании файла, предоставляя информацию о файлах, создаваемых процессами.

    -   Event ID 22 -   DNS Query
        Фиксирует DNS-запросы, выполняемые процессами, что может быть важно для идентификации доменных имен, вовлеченных в вредоносную деятельность.

А также инструментами, которые можно использовать для адаптации журналов *.evtx в удобночитаемый формат *.csv с последующим анализов в специальных приложениях:

    -   EvtxEcmd
        Это инструмент командной строки, который анализирует журналы событий Windows в различных форматах, таких как CSV, JSON, XML и т. д.

    -   TimelineExplorer
        Инструмент на основе графического интерфейса, который функционирует как приложение для фильтрации и навигации данных, чтобы облегчить специалистам по реагированию на инциденты обработку необработанных данных.

    -   EventViewer
        Это инструмент Microsoft Windows для просмотра системных журналов, журналов безопасности и журналов приложений, позволяющий устранять неполадки, оценивать состояние системы и отслеживать события безопасности

=====================================================================
* Задания *
***********

Как и всегда, разбор заданий будет идти по порядку, НО полученные сведения могут перекликаться между заданиями.
Более того, для подтверждения найденной "улики" в одном лог-файле, необходимо сравнить ее с данными из другого лог-файла 
Поэтому НАСТОЯТЕЛЬНО рекомендуется делать записи/пометки

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 1 - Опеределить количество журналов событий с идентификатором события 11 +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Для ответа на этот вопрос как правило используют один спосом    -   просмотр журнала чезер EventViewer
    Где после загрузки необходимого журнала, в разделе "Actions" (который в правой части рабочего окна), в меню "Filter Current Log...", необходимо указать номер события в полу "Included/Excudes Event IDs:..."
    И по отображаемом резальтате Вы сможеет увидеть количество записей интресующего Вас события.
    
    Однако, мы также рассмотрим другой вариант  -   использование одной утилиты из набора Эрика Циммермана "EvtxEcmd"
    После установки данной утилиты, Вы либо преходите в коммнадной строке в расположение этой утилиты, либо добавляете ее исполняемый файл в среду переменных
    Затем в коммандной строке (CMD или Powershell) необходимо выолнить следующую комманду:
    
         PS C:\Users\<user_name>> .\EvtxECmd.exe -f 'C:\Path\to\the\EVTX\logfile\file_name.evtx' --csv 'C:\Path\where\results\will\be\stored' --csvf <file_name>.csv

         ИЛИ

         PS C:\Path\to\the\folder\EvtxECmd> .\EvtxECmd.exe -f 'C:\Path\to\the\EVTX\logfile\file_name.evtx' --csv 'C:\Path\where\results\will\be\stored' --csvf <file_name>.csv
    
    Это трансформирует содержимой выбранного журнала из EVTX в CSV, чтобы Вы потом смогли открыть его в любом CSV редакторе (в нашем случае это будет   -   TimelineExplorer)
    *** Использование TimelineExplorer весьма полезно  в том случае, когда Вам нужно будет просомтреть содежание некоторых полей события сразу, а не просматривать событие за событием
        Или осуществлять поиск по ключевому слову
        Поэтому, лучше всего работать сразу в двух утилитах одновременно    -   EventViewer и TimelineExplorer

    Итак, после того как Вы переделали файл в CSV формат, открывам его в TimelineExplorer
    Затем находим стобец "Event ID" и вносим в него номер нужного нам события

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 2 - Опеределить какой вредоносный процесс заразил систему жертвы +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    При создании процесса в памяти регистрируется событие с идентификатором 1, содержащее такие сведения, как командная строка, хэши, путь к процессу, путь к родительскому процессу и т. д.
    Эта информация очень полезна для аналитика, поскольку позволяет нам видеть все программы, выполняемые в системе, а значит, обнаруживать любые вредоносные процессы

    Вот тут то нам и пригодиться TimelineExplorer, так как после указания номера события мы также получим список всех событий, удовлетворяющих критерию отображаемом
    Однако, если мы прокрутим результат вправо, то в столбце "Payload Data4" сможем увительназвание всех созданных процессов, вместо того, чтобы просматривать каждую запись по отдельности в EventViewer

    При проведении первоначального исследования мы сосредоточимся на полях «Image», «Parent Image» и « CommandLine fields».
    Это связано с возможностью подтверждения имени исполняемого файла, запустившего процесс, а также любого сгенерированного вывода командной строки.
    Вредоносная активность часто может быть подтверждена необычным именем процесса или необычным выводом командной строки.

    При просмотре событий нам стоит обращать внимание на необычные моменты, такие как:
    
        -   двойное расширение
        -   имя файла
        -   место запуска файла
    
    После обнаружения чего-то подозрителбно, Вы всегда сможете прогуглить ваши обнаружения для возможного совпадения в Интернете
    Ну или сразу отправить запрос в VirusTotal

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 3 - Опеределить какой облачный сервис использовался для распространения вредоносного ПО +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Тут придется расширить нашу област поиска, задействовав несколько различных событий, а именно   -   11 и 22
    Однако не спешите сбрасывать фильтр в TimelineExplorer
    Сперва запомните (а лучше запишите) дату/время, когда был создан процесс с вредоносным файлом
    Можно конечно добавить дополнительно события в фильтр, но бывает так, что событий может быть очень много и поэтому проще использовать временной диапозон
    Так как зачастую, все подохрительные события происходят достаточно близко друг от другая

    В нашем случае нам повезло  -   у нас не так много событий №1 и №22, так что мы смело можем включить их оба сразу
    Тем не менее, количество событий, предшествующих созданию вредоносного процесса больше одного
    Поэтому, нам стоить включить еще один фильтр    -   11

    В результате список событий увеличился значительно, но зная время создания вредоносного процесса, мы сможем отфильтровать ненужные записи
    Вот тут то нам в очередной раз поможет TimelineExplorer
    Сперва мы отсортируем события по времение (стоблец "Time Created"), а затем отфильтруем все ненужно по столбцу "Record Number", убрав все записи после номера записи, связанной с созданием вредоносного процесса
    После всего, прокручиваем впрадо до столбца "Payload Data4" и начинаем изучать содержимое каждой записи снизу вверх
    Ищем записи в названиях которых встречаются слова похожие на название найденного нами ранее вредоносного процесса

    Безусловно, каждый анализ уникален по своему, но подозрительные действия встретяся со 100%
    В нашем случае мы наткнемся на 3 записи, которые имеют отношение к нашему вредоновному процессу и который идут перед нашим вредоносным процессом:

        1)  <название_процесса>.<расширение>.Zone.identifier
            Это свидетельствует о том, что файл с одноименным названием был скачан из интернета через браузера
        
        2)  <набор_символов>.<расширение>.part (может быть несколько одинаковых записей, идущих друг за другом)
            Это говорит о том, что файл во время загрузки был разбит на несколько частей (part)

        3)  QueryName: <набо_других_символов_напоминающих_URL>
            Характеный DNS запрос

    Проанализировав полученную информацию, мы можем определить откуда был скачан файл, содержащий вредоносный процесс

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 4 - Опеределить запись, свидетельствующую об изменение временной метки +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Парой, для файлов, записанных на диск, вложенный вредоносный файл использует технику обхода защиты, называемую Time Stomping
    При ней дата создания файла изменяется, чтобы он выглядел старше и сливался с другими файлами.
    Изменяя эти данные, злоумышленник может скрыть свои следы, затрудняя для исследователей или антивирусного ПО определение того, когда файлы были фактически изменены или созданы.

    Для определния таких процессов нам понадобиться идентификатор событий №2

    Как правило, записей с таким идентификатором события будет не много, но нам надо определить -   у какого именной файла была изменена дата создания, вредоносным процессом, который мы обнаружил ранее
    Поэтому, в TimelineExplorer мы оставляем только Event ID #1 и #2
    А gолученном результате, сперва находим запись о создании нашего вредоносного процесса
    Это будет нашей отправной точкой для последующего анализа

    Далее, мы дожны обнаружить связующие элементы, такие как:

        -   RuleName
        -   Image
        -   TargetFilename
        -   CreationUtcTime
        -   PreviousCreationUtcTime
    
    Если вы предпочитаете работать с EventViewer, то для анализа ва достаточно Event ID #2
    Правда в таком случае, Вам придется просматривать содержимое каждой записи (благо их бывает не много)

    Если решили остаться с TimelineExplorer, то анализ столбцов "Payload Data..." покажет Вам всю картину в деталях

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 5 - Опеределить где на диске был записан один из вредоносных файлов, созданных вредоносным процессом +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Если мы знаем приблизительное название файла, тогда все просто  -   фильтруем по Event ID #11, а дальше по приблизительному названию файла

    Но бывает так, что основной вредоносный файл/процесс создает множество второстепенных вредоносных файлов/процессов
    И если он изменил время создание для основного, то все сопуствующие файлы/проыессы унаследуют это изменение.

    Поэтому, в TimelineExplorer мы сперва фильруем всё по Event ID #1 и #2, затем находим родительский вредоносный файл/процесс
    А дальше построчно просматриваем колонки с названием "Payload Data..."
    В них мы сможем увидеть для каких именно файлов/процессов была изменена дата

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 6 - Опеределить домен, к которому пытался подключиться вредоносный файл/процесс +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Для этого задания основной Event ID, который нам потребуется    -   это №22
    Мы уже использоавли его ранее, когда определяли с какого домена был скачан вредоносный процесс

    Теперь, нам надо опреедлить, на какой домен был отправлен запрос вредоносным процессом/файлом
    Если записей мало и сам вредоносный процесс отправлял запрос, тогда все просто  -   фильтра по Event ID 22 будет вполне достаточно
    В EventViewer среди отфильтрованных записей находим ту, в которой:

        -   Image = название вредоносного процесса/файла
        -   QueryName = домен, который запрашивал вредоносный процесс
    
    А вот если, основной вредоносный процесс насоздовал кучу второстепенных вредоносных процессов/файлов, то тут одним лишь фильтром по Event ID 22 нам не обойтись
    Придется обращаться к TimelineExplorer и фильтровать в том числе еще и по Event ID 1, 2, 3 и 11
    И как правило после создания второстепенного вредоносного процесса/файла будет либо DNS-запрос, либо запрос на IP-адресс

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 7 - Опеределить IP-адрес, к которому пытался подключиться вредоносный файл/процесс +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Как я говорил в предыдущем задании  -   если записей мало, то посредством EventViewer мы может отфильтровать события по Event ID 3, а дальше искать по:

        -   Image
        -   SourceIp
        -   DestinationIP
    
    Но если запрос был осуществлен не основным вредоносным процессом/файлом, то переходим в TimelineExplorer и фильтруем по Event ID 1, 2 и 3
    Ну а дальше я уже объяснял в предыдущем задании

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 8 - Опеределить IP-адрес, к которому пытался подключиться вредоносный файл/процесс +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Как правило, после того, как вредоносный процесс/файл выполняет поставленную задачу (заражение компьютера / создание бэкдоа / чего-то еще) он пытаеся стереть свои следы
    Одним из таких действия является    -   завершение процесса

    Для финализирования расследования и обнаружения данного типа процесса, нам понадобиться фильтр по Event ID 5