=====================================================================
* Введение *
************

Как Вы уже наверное значете, Zeek   -   обычно используется для тщательного изучения каждого бита трафика в сети, глубокого поиска любых признаков подозрительной или вредоносной активности.
Проще говоря, это такой же инструмент для анализа сетевого трафика, НО с другим (более узкоспециализированным) функционалом

Для подробной информции об общих и/или отличительных чертах Zeek от Wireshark, можно спросить ChatGPT или Google

!!! НО, очень часто Zeek используют для анализа пакетов собранных Wireshark (*.pcap)
    Поэтому, представленный ниже сценарий будет базироваться на анализе Zeek-ом некоторого *.pcap файла

Помимо взаимодействия с Zeek и Wireshark, будет также рассмотрено использование утилиты SPLUNK
Которая в свою очередь будет анализировать *.log файлы (это выжимка из *.pcap файла посредством Zeek/tShark) для отображения нужных результатов черех используемые фильтры

!!! Так как SPLUNK не работает на прямую с файлами типа *.pcap, то я КРАЙНЕ НАСТОЯТЕЛЬНО рекомендую ознакомиться с инструкцией по загрузки *.log файлов (каталогов) в базу данных SPLUNK

В данной презентации *.pcap файл уже был распарсен Zeek и все сформированные файлы были загружены в базу данных SPLUNK
Связанные материалы:

    -   PCAP-file           kerberos_bruteforce.pcap
    -   Splunk Index:       kerberos_bruteforce
    -   Splunk Sourcetupe:  bro:kerberos:json

Также перед оптимизацие фильтра, сперва рекомендую провести SPLUNK анализ без каких-либо уточняющих параметров
Это позволит увидеть вам название используемых полей-заголовков, которые мотом можно будет использовать для более тонкой настройки фильтрации

=====================================================================
* Detecting Kerberos Brute Force *
**********************************

Когда злоумышленники выполняют перечисление пользователей на основе Kerberos, они отправляют сообщение AS-REQ (Authentication Service Request) в Key Distribution Center (KDC), который отвечает за обработку аутентификации Kerberos.
Это сообщение включает имя пользователя, которое они пытаются проверить.
Они уделяют пристальное внимание полученному ответу, поскольку он раскрывает ценную информацию о существовании указанной учетной записи пользователя.

Действительное имя пользователя побудит сервер вернуть TGT или выдать ошибку
Например KRB5KDC_ERR_PREAUTH_REQUIRED, указывающую на необходимость предварительной аутентификации.
С другой стороны, недействительное имя пользователя будет встречено кодом ошибки Kerberos KRB5KDC_ERR_C_PRINCIPAL_UNKNOWN в сообщении AS-REP (Authentication Service Response).
Изучая ответы на свои сообщения AS-REQ, злоумышленники могут быстро определить, какие имена пользователей являются действительными в целевой системе.

Теперь давайте рассмотрим, как можно определить Kerberos Brute Force с помощью Splunk и Zeek logs

    index="kerberos_bruteforce" sourcetype="bro:kerberos:json" error_msg!=KDC_ERR_PREAUTH_REQUIRED success="false" request_type=AS
        | bin _time span=5m
        | stats count dc(client) as "Unique users" values(error_msg) as "Error messages" by _time, id.orig_h, id.resp_h
        | where count>30