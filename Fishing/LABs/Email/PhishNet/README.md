=====================================================================
* Легенда сценария *
********************

Бухгалтерский отдел получает срочный платёжный запрос от известного поставщика.  
Письмо выглядит легитимным, но содержит ссылку и ZIP-вложение, которые могут быть потенциально вредоносными и скрывать вредоносное ПО.  
Ваша задача — проанализировать заголовки письма и раскрыть схему действий злоумышленников.

Для анализа предоставлено:

- Сохранённое письмо (`email.eml`)

Вам необходимо сосредоточиться на обнаружении и анализе:

- IP-адресов  
- Адресов электронной почты (отправителя, получателя, транзитных, `Reply-To`)  
- Sender Policy Framework (SPF)  
- Домена злоумышленников  
- Возможных вложений  

Для этого потребуются следующие инструменты:

### Email Header Analyser
Инструмент для анализа заголовков электронных писем, позволяющий определить технические сведения об их происхождении, маршруте и возможной подделке.  
Рекомендуемые онлайн-сервисы:

- <https://mha.azurewebsites.net/>  
- <https://toolbox.googleapps.com/apps/messageheader/analyzeheader>  
- <https://mxtoolbox.com/Public/Tools/EmailHeaders.aspx>

### URL Extractor
Инструмент для извлечения всех URL-адресов из текстового файла.  
Рекомендуемые сервисы:

- <https://www.convertcsv.com/url-extractor.htm>  
- <https://cyberchef.org>

### Email Attachment Analyzer
Инструмент для безопасного анализа вложений фишинговых писем в формате `.eml`.  
Он извлекает вложения, вычисляет их хэши выбранными алгоритмами (а для ZIP-файлов отображает содержимое и вычисляет хэши вложенных файлов в памяти, без распаковки на диск).  
> ⚙️ Этот инструмент был создан самостоятельно на Python с использованием AI.

---

=====================================================================
* Задания *
***********

Как и всегда, разбор заданий идёт по порядку, **но полученные сведения могут пересекаться между заданиями.**  
Для подтверждения найденных «улик» из одного источника необходимо сверять их с другими данными.  
Поэтому настоятельно рекомендуется делать записи и пометки.

---

### + Задание 1 — Какой исходный IP-адрес отправителя?

Загрузите письмо или его исходный текст в онлайн-анализатор и изучите результат.  
В зависимости от используемого инструмента IP-адрес может находиться в разных полях.  
Чаще всего используется поле **`X-Originating-IP`**.

---

### + Задание 2 — Какой почтовый сервер передал письмо перед получателем?

Необходимо определить цепочку перемещений письма от одного сервера к другому (так называемые *hops*).  
Таких переходов может быть несколько.  
Обычно анализаторы отображают эту информацию в начале отчёта (реализация зависит от конкретного сервиса).

---

### + Задание 3 — Какой адрес электронной почты указан как отправитель?

Если письмо прошло несколько промежуточных серверов, полезно рассмотреть все задействованные адреса.  
Однако для этого задания нужен **последний использованный адрес**, который непосредственно отправил письмо получателю.

---

### + Задание 4 — Какой адрес электронной почты указан в заголовке `Reply-To`?

Заголовок **`Reply-To`** часто используется злоумышленниками.  
Многие пользователи считают, что письмо возвращается по адресу, с которого оно пришло.  
В легитимных письмах так и есть — поля `From` и `Reply-To` совпадают.  
Однако в фишинговых письмах адрес в `Reply-To` может быть **другим**, чтобы перенаправить ответ злоумышленнику.  
Сравните значения `From` и `Reply-To`, чтобы выявить несоответствия.

---

### + Задание 5 — Каков результат SPF (Sender Policy Framework) для этого письма?

**Sender Policy Framework (SPF)** — это механизм защиты от подделки адреса отправителя (спуфинга).  
SPF — это DNS-запись домена, указывающая, какие серверы имеют право отправлять письма от имени данного домена.  

При получении письма почтовый сервер проверяет, разрешён ли IP-адрес отправителя в SPF-записи указанного домена.  
Если нет — письмо помечается как подозрительное (spam, phishing и т. д.).

> ⚠️ SPF проверяет не поле “From”, которое видит пользователь, а техническое поле “envelope-from”.

SPF часто используется вместе с:

- **DKIM** (DomainKeys Identified Mail) — проверяет подлинность содержимого письма через криптографическую подпись (определяет, изменялось ли письмо).  
- **DMARC** (Domain-based Message Authentication, Reporting & Conformance) — объединяет SPF и DKIM и задаёт политику обработки писем при сбоях (reject / quarantine / none).

---

### + Задание 6 — Какой домен используется в фишинговом URL внутри письма?

Фишинговые письма часто содержат на первый взгляд безобидные ссылки.  
Обычно они маскируются под вложения («нажмите, чтобы скачать файл»).  
При переходе по таким ссылкам пользователь может загрузить вредоносный файл или передать свои данные злоумышленнику.

Чтобы определить, куда ведёт ссылка:

- Наведите на неё курсор мыши (не кликая) — внизу окна появится реальный URL.  
- Используйте **URL Extractor**, чтобы извлечь все скрытые ссылки из письма.

---

### + Задание 7 — Какое название компании использовал злоумышленник, чтобы письмо выглядело правдоподобным?

Злоумышленники стараются сделать письмо максимально похожим на настоящее.  
Одним из элементов подделки является **название организации** в заголовке письма.  

Настоящие письма содержат поле **`X-Organization`**, которое добавляется почтовым сервером компании-отправителя.  
Обычно это имя совпадает с доменом организации.  
Если письмо поддельное, это поле может быть пустым или содержать несуществующую организацию.

---

### + Задание 8 — Каков хэш вложения?

Вложения в фишинговых письмах часто содержат вредоносное ПО.  
Определение хэша вложения позволяет проверить его на сервисах вроде VirusTotal.  

Если злоумышленник использует известный вредонос, вы сможете идентифицировать его функции по хэшу.  
Если вредонос новый — потребуется ручной анализ.  

Два основных способа вычислить хэш (в безопасной среде, например, в песочнице):

- Скачать вложение и вычислить хэш системными средствами:

  ```
  # Windows
  Get-FileHash "C:\path\to\file.*" -Algorithm SHA256

  # Linux
  sha256sum /path/to/file.*

  # macOS
  shasum -a 256 /path/to/file.iso

---

### + Задание 9 — Каково имя вредоносного файла внутри ZIP-вложения?

В реальном случае потребуется открыть архив или хотя бы просмотреть его содержимое.
(Например, мой Python-скрипт позволяет определить хэш каждого файла внутри архива без его распаковки.)

---

### + Задание 10 — Какие техники MITRE ATT&CK связаны с этой атакой?

Перейдите на сайт <https://attack.mitre.org/> и подберите соответствующие техники, связанные с данным сценарием.

