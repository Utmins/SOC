
=====================================================================
* Легенда сценария *


Бухгалтерский отдел получает срочный платежный запрос от известного поставщика.
Письмо выглядит легитимным, но содержит ссылку и ZIP-вложение, которые могут быть потенциально зловредными и скрывать вредоносное ПО.
Ваша задача — проанализировать заголовки письма и раскрыть схему злоумышленников.

Для анализа были предоставлены:

    -   Сохраненное письмо (email.eml);

Таким образом Вам надо будет сосредоточился на обнаружении и анализе:
    
    -   IP адресов
    -   email фдресов (отправителя, получателя, транзитных, reply-to)
    -   Sender Policy Framework
    -   доменов злоумышленника
    -   возможных вложений

Поэтому, для анализа электронных писем Вам потребуются:

    -   Email HEADER Analyser
        Анализатор заголовков электронного письма, который используется для определения технических сведений о его происхождении, маршруте и возможной подделке.
            https://mha.azurewebsites.net/
            https://toolbox.googleapps.com/apps/messageheader/analyzeheader
            https://mxtoolbox.com/Public/Tools/EmailHeaders.aspx?huid=8e7fe0a3-a618-4bdd-9db3-150bc83681fe
    
    -   URL Extractor
        Инструмент позволяющий вытаскиать любые URL из текстового файла
            https://www.convertcsv.com/url-extractor.htm
            https://cyberchef.org

    -   Email Attachment Analyzer
        Инструмент для безопасного анализа вложений фишинговых писем в формате .eml.
        Он извлекает вложения, вычисляет их хэши выбранными алгоритмами (а для ZIP-файлов отображает содержимое и считает хэши внутренних файлов в памяти, без распаковки на диск).
        *** Данный инструмент был создан самостоятельно на основе Python с использованием AI

=====================================================================
* Задания *
***********

Как и всегда, разбор заданий будет идти по порядку, НО полученные сведения могут перекликаться между заданиями.
Более того, для подтверждения найденной "улики" в одном лог-файле, необходимо сравнить ее с данными из другого лог-файла 
Поэтому НАСТОЯТЕЛЬНО рекомендуется делать записи/пометки

    ++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 1 - Какой исходный IP-адрес отправителя? +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++

    Тут все очень просто - загружаем либо само письмо (если позволяет инструмент), либо его исходный текст в он-лайн анализатор и смотрим Результат
    В зависимости от используемого инструмента IP адрес может находиться в разных полях
    Чаще всего поле зазывается  -   X-Originating-IP

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 2 - Какой почтовый сервер передал это письмо до того, как оно достигло жертвы? +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Тут немного посложнее.
    Нужно найти информацию, которая отображает перемещение письма от одного источника к другому
    Таких перемещений (hops) может быть много
    Как правило анализатор размещает это в самом начале своего отчета (разный анализатор отображает это по-разному)

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 3 - Какой адрес электронной почты отправителя? +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Если письмо совершило несколо "прыжков" перед тем как достичь получателя, т елях бзопасностинам потребуютсяявсе задействоанные адреса
    Но для задания нм нужен послднй исполованый адрес
    
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 4 - Какой адрес электронной почты указан в заголоке 'Reply-To' +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Reply-To    -   очень хитрый заголовок
    В большинстве случаев, многие думают, что когда вы отправлете письмо получателю, то оно уходит туда, откуда пришло
    В письмах от "настоящих" отправителй так и происходит
    И поле From и Reply-To содержат один и тот же адрес
    Но, если письмо пришло от злоумышленника, то поле Reply-To будет содержать другой адрес
    Поэтому, налазин заголовков электронного письма должен определить сходство или расхождение этих полей
    
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 5 - Каков результат SPF (Sender Policy Framework) для этого письма? +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Sender Policy Framework (SPF)   -   это один из ключевых механизмов защиты от подделки адресов отправителя (спуфинга) в электронной почте.
    Простыми словами, SPF   -   это DNS-запись домена, которая указывает, какие серверы имеют право отправлять письма от имени этого домена.
    Когда почтовый сервер получает письмо, он проверяет, действительно ли IP-адрес отправителя разрешён доменом получателя в его SPF-записи.
    Если нет — письмо помечается как подозрительное (spam, phishing и т.д.).
    Т.е. проверяет, кто имеет право отправлять письма от домена

    SPF не проверяет поле “From”, которое видит пользователь.
    Он проверяет “envelope-from” (техническое поле SMTP).
    Поэтому SPF часто используется вместе с:
        DKIM (DomainKeys Identified Mail) — проверяет подлинность содержимого письма через криптоподпись (другими словами   -   не было ли изменено содержимое письма);
        DMARC (Domain-based Message Authentication, Reporting & Conformance) — объединяет SPF и DKIM и задаёт политику действий при сбое (reject / quarantine / none).

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 6 - Какой домен используется в фишинговой URL-адресе внутри письма? +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Часто фишинговые письма содержат, на первый взгляд безобидные, ссылки
    Чаще всего данные ссылки замаскиорванны под вложения    -   мол, нажми на приложения, чтобы скачать файл (ну или то, о чем говориться в письме).
    Помимо скачивания указанного в письме файла, Вы можете скачать и зловред или поделиться информацией со злоумышленником.

    Чтобы узнать, куда вы будете перенаправлены, если нажмете на указанный элемент письма, то можно:

        -   либо просто навести на него указателм мышки (но не нажимать) и внизу окна появиться URL, который связан с данным элементом
        -   либо воспользоваться он-лайн URL Extractor, который отобразит скрытые URL

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 7 - Какое название компании использовал злоумышленник в электронном письме, чтобы письмо выглядело более правдоподобным +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Злоумышленники, использующие фишингловые письма, как точку входы в системы жертвы создают свои письма максимально приближенным в реальным
    Безусловно, если фишинговое письмо пришло от начинающего злоумышленника, то при анализе исходного кода письма будет выявленного множество расхождений
    Одним из таких расхождений будет являться "Organization Name" или название организации отправившей письмо.

    Почтовый сервер реальной организации всегда будет добавлять данную информацию в соответсвующий заголовок электронного письма
    Даный заголовок называется  -   X-Organization
    И как правило, название организации коррелируется с названием домена, откуда пришло письмо
    Но, если письмо пришло от начального уровня злоумышленника, то скорее всего данный заголовок будет пустым 
    
    +++++++++++++++++++++++++++++++++++
    + Задание 8 - Каков хэш вложения? +
    +++++++++++++++++++++++++++++++++++

    Как правило, в фишинговях письмах вложения (прикрепленные к письма файлы) содержат зловред.
    Если, злоумышленник использовал известных зловред, то высока вероятность, то определив ХЭШ вложения, Вы через базу VirusTotal сможете определить непосредственно сам зловреди его функции
    А если, злоумышленник опытный, то Вам придется анализировать вложения вручную и более детально
    В том и другом случае сперва необходимо определить ХЭШ вложения.

    Тут существуют два способа (оба рекомендуется делать в песочнице):

        -   скачать вложения и спомощью встроенных инструментов вашей ОС (или ОС песочницы) выявить ХЭШ

                WinOS:  Get-FileHash "C:\path\to\file.*" -Algorithm SHA256
                Linux:  sha256sum /path/to/file.*
                MacOS:  shasum -a 256 /path/to/file.iso

        -   воспользоваться сторонним скриптом, для анализца копии всего письма, а не только вложения (bash / python / powershell)

    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 9 - Каково имя вредоносного файла, содержащегося в ZIP-вложении? +
    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    В реальном случа придется придется открыть архив, ну или просмотреть его содержимое (кстати, мой питон-скрипт позволяет определить хэш каждого вложенного в архив файла)

    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
    + Задание 10 - Какие методы MITRE ATT&CK связаны с этой атакой? +
    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

    Переходим на сайт https://attack.mitre.org/ и ищем подходящую технику
