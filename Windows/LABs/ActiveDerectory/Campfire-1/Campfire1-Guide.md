# Campfire1 — Руководство
### Практическое руководство по расследованию Kerberoasting-инцидента

---

## 1. Введение

Пользователь сообщил SOC о наличии подозрительных файлов на рабочей станции. Предварительный анализ указывает на возможную атаку Kerberoasting в среде Active Directory.

Предоставленные артефакты:
- Журналы безопасности контроллера домена: `Security-DC.evtx`
- PowerShell Operational логи с рабочей станции: `Powershell-Operational.evtx`
- Prefetch-файлы с пострадавшей станции

Задача — подтвердить или опровергнуть факт Kerberoasting, собрать IOCs (IP-адреса, учётные записи, имена файлов, временные метки) и сопоставить поведение с техникой MITRE ATT&CK **T1558.003**.

---

## 2. Цели анализа

1. **Зафиксировать временные рамки активности**  
   *Ожидаемый результат:* коридор времени (начало/конец) с ключевыми метками событий и списком соответствующих Event ID.

2. **Выявить сервисы, на которые велась атака**  
   *Ожидаемый результат:* перечень уникальных целевых Service Principal Names (SPN) или ServiceName с временными метками запросов.

3. **Определить источник запросов в сети**  
   *Ожидаемый результат:* IP-адрес(а) и (при наличии) имя хоста клиента, связанное с подозрительными событиями в логах.

4. **Найти используемый для сбора данных код или бинарь**  
   *Ожидаемый результат:* имя/путь скрипта или исполняемого файла и выдержки из ScriptBlock/лога, подтверждающие его роль в перечислении AD/SPN.

5. **Установить точные моменты исполнения инструментов**  
   *Ожидаемый результат:* точные метки запуска для подтверждения корреляции с активностью на контроллере домена.

6. **Получить сведения о запущенном исполняемом файле и его местоположении**  
   *Ожидаемый результат:* запись с полным путём к бинарю, количеством запусков и временем последнего запуска.

7. **Сопоставить наблюдаемые артефакты с тактиками и подготовить рекомендации**  
   *Ожидаемый результат:* привязка к MITRE.

---

## 3. Основные события при анализе Kerberoasting атак

Kerberoasting — метод, при котором злоумышленник запрашивает сервисные Kerberos-билеты (TGS) для SPN и затем пытается сломать зашифрованные части билетов офлайн (MITRE ATT&CK: **T1558.003**).

Ключевые события Windows, на которые следует обратить внимание:
- **Event ID 4768** — запрос TGT (Ticket Granting Ticket).  
- **Event ID 4769** — запрос TGS (service ticket) для SPN.  
- **Event ID 4624 / 4625** — успешные / неуспешные входы.  
- **Event ID 4648** — попытка входа с явными учетными данными.  
- **Event ID 4688** — создание процесса.  
- **Event ID 4104** — ScriptBlock logging (PowerShell).

---

## 4. Инструменты и ресурсы

| Категория | Назначение | Рекомендации |
|---|---:|---|
| Конвертация EVTX | Преобразование Windows-логов в CSV/JSON | `EvtxEcmd`, `wevtx`, PowerShell `Get-WinEvent` |
| Анализ Prefetch | Разбор prefetch-артефактов | `PECmd` |
| Временная линия | Корреляция событий | `TimelineExplorer`, ELK/Splunk |
| Логи PowerShell | Анализ ScriptBlock (ID 4104) | Event Viewer, `LogParser` |
| Утилиты | CLI для обработки | `jq`, `grep`, `awk`, `sed` (Linux/WSL) |

> ⚠️ Все действия выполняйте только в изолированной лабораторной среде (VM / песочница). Работайте с копиями артефактов — не анализируйте подозрительные бинарники на продуктивных системах.

---

## 5. Порядок выполнения

### Задание 1 — Опеределить дату и время, когда произошла атака Kerberoasting
**Цель:** найти период времени с подозрительной активностью.

На первый взгляд определить дату и время, когда произошла Kerberoasting атака, может показаться всер-равно, что найти иголку в стоку сена.
И если атака была произведена грамотным специалистом, а Ваша система безопасности не была походжа на швейцарский сыр.
То это будет действитльно не простая задача, так как Вам придется проанализировать сотни логов.

Однако в нашем случае все гораздо проще.
Для определение несостыковок, которые указывают на возможную Kerberoasting атаку, нам надо будет проанализировать всего один журнал -   Securty of Domain Controller.evtx

**Шаги:**
1. **Сперва мы проверим на наличие событий с ID 4648**  
   Мониторинг этого события может указывать на то, как и когда использовались несанкционированные учётные данные для входа в систему.
   Таким образом, мы сможем определить исходный аккаунт, который инициировал процесс с использованием предоставленных учётных данных.

2. **Затем переходим с возможному списку событий с ID 4624 и 4625**  
   Это даст нам представления об успешных/неудачных попытка схода в систему.
   Т.е. если один и тот же аккаунт после множетсва неудачных попыток смог войти в систему.
   То это означает, что данный аккаунт был скопрометирован.

3. **Следующее ID события на которое стоит обратить внимание - 4768**  
   Данное событие предоставит нам информацию какие пользователи запросили билет аутентификации Kerberos.
   Особое внимание стоит уделять на имя аккаунта, который запрашивал и присвоенный запросу статус.

   Нет ничего не обычного, когда пользователь запрашивает билет TGT на доступ к компьютеру.
   Но, если данному пользователю не были выданы права на доступ к запрашиваемым ресурсам, а он получил доступ, то это свидетельствует о том, что билет был поддельный.

   Также, если запрос приходит от пользователя, чей аккаунт более не активен в системе.

4. **Ну и в заключение, проверяем ID 4769**  
   Тут мы проверяем на соответствие пользователя к запрашиваемым сервисам/службам.
   Как уже было сказано, если у пользователя нет прав на пользование определнными сервисами, то авторизация на данном сервисе сигнализирует о взломе.

   Особое внимние стоит образать на способ шифрования билета (TicketEncryptionType)   -   он должен отличаться от всех остальных и иметь более нихний уровени.
   Если обычно значение этого поля будет равно `0x12`, то у скопроментированного билета она будет отличаться, к примеру = `0x17`

Анализировать записи журналов можно разными способами.
Вот 3 наиболее попудярных:

- **EventViewer**  
   Стандартный просмоторщик журналов Windows.
   В теории его хватает, но его система фильтрации (XML-query) весьма капризна к пользовательским запросам и часто глючит.
   Но отображение данных по выбранной записи - одно из лучших.

- **TimelineExplorer*** с предварительной трасформацие журнала в CSV формат  
   Очень удобный анализатор различных жерналов, которые предварительно были переделаны в CSV формат.
   Имеет очень гибкие пользовательские фильтры.
   Но, из-за того, что поля трансформированы с столбцы, финальное отображение весьма растянуто и поэтому очень часто прихожить прокручивать изображение вправо-влево.

- **SIEM** модули (на примеру **Splunk**)  
   Очень удобный как и пользовательским фильтрам, так и по визуальному восприятию.
   Один минус  -   не умеет работать со сторонними журналами evtx (он их просто не читает, даже исли установить Windows Add-on).
   Поэтому, его надо либо загружать на машине, на которой происходит анализ, либо через агенты.
   Можно конечно через трансформацию журнала в CSV/JSON, но в таком случае есть шанс, что некоторые поля целиком уйдут в столбец без нормального распарсивания.

**Примечание:** Kerberoasting часто проявляется как серия запросов 4769 для разных SPN с одного хоста/учетной записи в короткий промежуток времени.

---

### Задание 2 — Опеределить имя сервиса, который стало целью атаки
**Цель:** выяснить, какие SPN запрашивались атакующим.

**Действия**

&nbsp;&nbsp;&nbsp;&nbsp;После того, как вы определили запись, которая свидетельствует об использовании поддельного TGT/TGS билета.  
&nbsp;&nbsp;&nbsp;&nbsp;То, проанализировав данную запись, Вы сможете опеределить имя сервиса, который подвергся атаке.
   
&nbsp;&nbsp;&nbsp;&nbsp;Вам необходимо найти запись содержащую уникальное, либо отличную от большинства других значений.  
&nbsp;&nbsp;&nbsp;&nbsp;Дело в том, что название службы (service) как правило не содержит в своем наименование символ `$`, так как он присущ рабочим станциям (`DC01$` - Domain Contorller или `FORELA-WKSTN001$` - имя хоста).  

> ⚠️ Если вы работаете с CSV файлом (к примеру используя **Timeline Explorer**), то стоит обащать внимание на один из столбцов "Payload", который содержит в себе информацию по "ServiceName". 

---

### Задание 3 — Опеределить IP-адрес рабочей станции, с которой была выполнена атака Kerberoasting
**Цель:** определить клиентский IP, с которого выполнялись подозрительные запросы.

**Действия**

&nbsp;&nbsp;&nbsp;&nbsp;Если используете EventViewer, то обратите внимание на поле **Network Information: Client Address: ...**  

&nbsp;&nbsp;&nbsp;&nbsp;А если другие инструменты (к примеру **Timeline Explorer**), то:

      -   либо однин из столбцов **Payload**
      -   либо столбец **RemoteHost**

---

### Задание 4 — Опеределить имя файла, используемого для перечисления объектов Active Directory и, возможно, поиска учетных записей Kerberoastable в сети
**Цель:** найти PowerShell-скрипт или исполняемый файл, который выполнял сбор данных AD/SPN.

**Действия**

&nbsp;&nbsp;&nbsp;&nbsp;Помимо журнала, который мы уже использовали, для ответа на данный вопрос в нашем случае потребуется другой журнал    -   Powershell-Operational.evtx  
&nbsp;&nbsp;&nbsp;&nbsp;С его помощью мы сможем определить какие именно Powershell скрипты были запущены.  

&nbsp;&nbsp;&nbsp;&nbsp;Но сперва мы проверим журнал Securty of Domain Controller.evtx  
&nbsp;&nbsp;&nbsp;&nbsp;Дело в том, что нам сначало надо удостовериться, что не было запущенно никаких других, кроме Powershell, исполняемых файлов/скриптов/комманд.  
&nbsp;&nbsp;&nbsp;&nbsp;К примеру python или cmd.  

&nbsp;&nbsp;&nbsp;&nbsp;И если мы ничего ужасного не нашли, то переходим к анализу журнала Powershell-Operational.evtx  
&nbsp;&nbsp;&nbsp;&nbsp;Где среди множества записей мы должны найти те, которые совпадают (или около) по времени и Account Name с теми, что мы обнаружили в вопросе №1  
&nbsp;&nbsp;&nbsp;&nbsp;И раз уж в нашем случае мы точно знаем, что это был Powershell скрипт, то мы также  можем отфильтровать данный Event ID по параметру ".ps1"  

⚠️ **Примечание:** обнаружение вызовов для получения SPN или использования модулей Kerberoast — сильное подтверждение атаки.

---

### Задание 5 — Опеределить когда был использован файл, найденный в впоросе 4
**Цель:** установить точные временные метки выполнения для корреляции с логами контроллера домена.

**Действия**

&nbsp;&nbsp;&nbsp;&nbsp;Ну, тут все просто  -   смотрим поле **TimeStamp** или **TimeCreated**

&nbsp;&nbsp;&nbsp;&nbsp; Для дополнительной проверки можно глянуть Prefetch файлы.

---

### Задание 6 — Опеределить имя и полный путь к утелите, которая была использована для проведения атаки Kerberoasting
**Цель:** установить имя исполняемого файла и путь на хосте.

**Шаги:**

1. Сперва нам надо найти, что это за утилита такая.
   А раз уж анализ скрипта Powershell нам не дал никакой полезной информации, то придется нам анализировать Prefetch файлы.
   Помимо основного значения этих журналов (можно почитать в интеренте).
   Эти файлы являются ценными источниками информации, так как они содержат следы запуска программ, включая вредоносное ПО. 

2. Для работы с Prefetch файлами нам сперва надо конвертировать их в CSV или JSON через PECmd и загружаем либо в TimelineExplorer, либо в SIEM платформу (в нашем случае Splunk).
   Результат транфсморфации может выдать огромное количество записей, которые мы устанем анализировать.
   
   Поэтому, нам надо отфильтровать их по времени.
   А так как мы знаем, когда был скомпрометирован билет и когда был запущен Powershell скрипт, который обнаружил Kerberos аккаунты.
   То, выставляем нужный временной интервал таким образом, чтобы использование данной утилита приходилось на выбранный временной диапозон.

3. Отфильтровав по временному отрезку мы можем определить какиая именно утилита была использована.
   Наименование и/или расположение этой утилиты будет явно отличаться среди остальных, что вызовет сомнения в ее легетимности.

**Для конвертации Prefetch в CSV используйте утилту из набора Эрика Циммермана - `PECmd`:**
```bash
pecmd.exe -f prefetch_folder -o prefetch.csv
```

⚠️**Примечание:** Prefetch содержит имя файла, путь и количество запусков — эти данные помогают связать бинарь с подозрительной активностью.

---

### Задание 7 — Определить время запуска найденной утилиты
**Цель:** получить точную метку запуска для корреляции с 4769-запросами.

**Шаги:**

&nbsp;&nbsp;&nbsp;&nbsp;Тут все также просто - Смотри на вопрос №5.

⚠️ **Примечание:** совпадение временных меток между запуском утилиты, ScriptBlock-логами и массовыми 4769-запросами даёт высокую уверенность в связи между утилитой и атакой.

---


