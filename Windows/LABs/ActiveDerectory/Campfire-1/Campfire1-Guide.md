# Campfire1 — Руководство
### Практическое руководство по расследованию Kerberoasting-инцидента

---

## 1. Введение

Пользователь сообщил SOC о наличии подозрительных файлов на рабочей станции. Предварительный анализ указывает на возможную атаку Kerberoasting в среде Active Directory.

Предоставленные артефакты:
- Журналы безопасности контроллера домена: `Security-DC.evtx`
- PowerShell Operational логи с рабочей станции: `Powershell-Operational.evtx`
- Prefetch-файлы с пострадавшей станции

Задача — подтвердить или опровергнуть факт Kerberoasting, собрать IOCs (IP-адреса, учётные записи, имена файлов, временные метки) и сопоставить поведение с техникой MITRE ATT&CK.

---

## 2. Цели анализа

1. **Зафиксировать временные рамки активности**  
   *Ожидаемый результат:* коридор времени (начало/конец) с ключевыми метками событий и списком соответствующих Event ID.

2. **Выявить сервисы, на которые велась атака**  
   *Ожидаемый результат:* перечень уникальных целевых Service Principal Names (SPN) или ServiceName с временными метками запросов.

3. **Определить источник запросов в сети**  
   *Ожидаемый результат:* IP-адрес(а) и (при наличии) имя хоста клиента, связанное с подозрительными событиями в логах.

4. **Найти используемый для сбора данных код или бинарь**  
   *Ожидаемый результат:* имя/путь скрипта или исполняемого файла и выдержки из ScriptBlock/лога, подтверждающие его роль в перечислении AD/SPN.

5. **Установить точные моменты исполнения инструментов**  
   *Ожидаемый результат:* точные метки запуска для подтверждения корреляции с активностью на контроллере домена.

6. **Получить сведения о запущенном исполняемом файле и его местоположении**  
   *Ожидаемый результат:* запись с полным путём к бинарю, количеством запусков и временем последнего запуска.

7. **Сопоставить наблюдаемые артефакты с тактиками и подготовить рекомендации**  
   *Ожидаемый результат:* привязка к MITRE.

---

## 3. Основные события при анализе Kerberoasting атак

Kerberoasting — метод, при котором злоумышленник запрашивает сервисные Kerberos-билеты (TGS) для SPN и затем пытается сломать зашифрованные части билетов офлайн (MITRE ATT&CK: **T1558.003**).

Ключевые события Windows, на которые следует обратить внимание:
- **Event ID 4768** — запрос TGT (Ticket Granting Ticket).  
- **Event ID 4769** — запрос TGS (service ticket) для SPN.  
- **Event ID 4624 / 4625** — успешные / неуспешные входы.  
- **Event ID 4648** — попытка входа с явными учетными данными.  
- **Event ID 4688** — создание процесса.  
- **Event ID 4104** — ScriptBlock logging (PowerShell).

---

## 4. Инструменты и ресурсы

| Категория | Назначение | Рекомендации |
|---|---:|---|
| Конвертация EVTX | Преобразование Windows-логов в CSV/JSON | `EvtxEcmd`, `wevtx`, PowerShell `Get-WinEvent` |
| Анализ Prefetch | Разбор prefetch-артефактов | `PECmd` |
| Временная линия | Корреляция событий | `TimelineExplorer`, ELK/Splunk |
| Логи PowerShell | Анализ ScriptBlock (ID 4104) | Event Viewer, `LogParser` |
| Утилиты | CLI для обработки | `jq`, `grep`, `awk`, `sed` (Linux/WSL) |

> ⚠️ Все действия выполняйте только в изолированной лабораторной среде (VM / песочница). Работайте с копиями артефактов — не анализируйте подозрительные бинарники на продуктивных системах.

---

## 5. Порядок выполнения

### Задание 1 — Определить временной интервал инцидента
**Цель:** найти период времени с подозрительной активностью.

**Шаги:**
1. Экспортировать события 4768, 4769, 4648, 4624, 4625:
```powershell
Get-WinEvent -Path .\Security-DC.evtx -FilterHashtable @{Id=4768,4769,4648,4624,4625} | Export-Csv -Path headers.csv -NoTypeInformation
```
2. Отфильтровать события 4769 и найти серии запросов в коротком интервале времени.  
3. Сопоставить с событиями 4648/4624/4625 для понимания использования учетных данных.

**Примечание:** Kerberoasting часто проявляется как серия запросов 4769 для разных SPN с одного хоста/учетной записи в короткий промежуток времени.

---

### Задание 2 — Определить целевые сервисы (ServiceName / SPN)
**Цель:** выяснить, какие SPN запрашивались атакующим.

**Шаги:**
1. В извлечённых 4769-записях найдите поле `ServiceName` / `Service Principal Name`.  
2. Соберите уникальные значения SPN и обратите внимание на сервисы типа `MSSQLSvc/host:port`, `HTTP/host`, `LDAP/host` и т.д.

**Команда (пример):**
```powershell
Import-Csv headers.csv | Where-Object {$_.Id -eq 4769} | Select-Object TimeCreated,TargetUserName,ServiceName | Sort-Object TimeCreated
```

---

### Задание 3 — Найти IP-адрес рабочей станции-источника
**Цель:** определить клиентский IP, с которого выполнялись подозрительные запросы.

**Шаги:**
- В поле `Network Information: Client Address` (или `ClientAddress` / `RemoteHost` в CSV) найти IP и при возможности — имя хоста.

**Пример (PowerShell):**
```powershell
Import-Csv headers.csv | Where-Object {$_.Id -in 4768,4769} | Select TimeCreated,@{n='ClientIP';e={$_.ClientAddress}},TargetUserName
```

---

### Задание 4 — Определить скрипт или файл, использованный для перечисления
**Цель:** найти PowerShell-скрипт или исполняемый файл, который выполнял сбор данных AD/SPN.

**Шаги:**
1. Экспортируйте записи 4104 из `Powershell-Operational.evtx`:
```powershell
Get-WinEvent -Path .\Powershell-Operational.evtx -FilterHashtable @{Id=4104} | Export-Csv -Path ps_4104.csv -NoTypeInformation
```
2. Фильтруйте по учетной записи, инициировавшей 4769-запросы.  
3. Поискуйте в содержимом ScriptBlock ключевые слова: `Get-ADUser`, `Get-ADComputer`, `Get-ADServiceAccount`, `Setspn`, `Invoke-Kerberoast` и т.д.

**Интерпретация:** обнаружение вызовов для получения SPN или использования модулей Kerberoast — сильное подтверждение атаки.

---

### Задание 5 — Определить время запуска скрипта/утилиты
**Цель:** установить точные временные метки выполнения для корреляции с логами контроллера домена.

**Шаги:**
- Используйте `TimeCreated` в 4104 и события 4688 (создание процесса) для получения времени запуска.  
- Перекрестно проверьте с префетч-данными.

**Команда (пример):**
```powershell
Get-WinEvent -Path .\Security-DC.evtx -FilterHashtable @{Id=4688} | Where-Object { $_.Message -match 'powershell|cmd|python' } | Select TimeCreated, Message
```

---

### Задание 6 — Определить утилиту и полный путь (через Prefetch)
**Цель:** установить имя исполняемого файла и путь на хосте.

**Шаги:**
1. Конвертируйте Prefetch в CSV с помощью `PECmd`:
```bash
pecmd.exe -f prefetch_folder -o prefetch.csv
```
2. Импортируйте результаты в таймлайн и фильтруйте по временному окну.

**Интерпретация:** Prefetch содержит имя файла, путь и количество запусков — эти данные помогают связать бинарь с подозрительной активностью.

---

### Задание 7 — Определить время запуска найденной утилиты
**Цель:** получить точную метку запуска для корреляции с 4769-запросами.

**Шаги:** сопоставьте метки Prefetch и события 4688, чтобы получить точную временную привязку.

**Примечание:** совпадение временных меток между запуском утилиты, ScriptBlock-логами и массовыми 4769-запросами даёт высокую уверенность в связи между утилитой и атакой.

---

## ✅ Что должно быть в итоговом отчёте

1. Краткое резюме: описание инцидента, затронутые активы, уровень риска.  
2. Таймлайн: хронология ключевых событий с метками времени и ID.  
3. IOCs:
   - IP-адреса источников (ClientAddress).  
   - Целевые сервисные учётные записи и SPN.  
   - Пользовательские учётные записи (TargetUserName).  
   - Имена файлов/пути и доступные хэши (Prefetch/извлечённые файлы).  
4. MITRE ATT&CK: указать **T1558.003 — Kerberoasting** и аргументацию.  
5. Рекомендации по устранению:
   - Сброс паролей скомпрометированных сервисных аккаунтов.  
   - Ограничение прав сервисных учётных записей.  
   - Включение/проверка аудита Kerberos и логирования PowerShell.  
   - Поиск с помощью EDR на исходном хосте и по сходным индикаторам.

---

## 🔒 Меры предосторожности при анализе

- Работайте только с копиями артефактов.  
- Не запускать подозрительные файлы вне изолированной среды.  
- Сохраняйте экспортированные CSV/JSON и журналы для IR и возможных правовых процедур.

---

## 🛠 Быстрые команды / шаблоны

- Экспорт событий безопасности:
```powershell
Get-WinEvent -Path .\Security-DC.evtx -FilterHashtable @{Id=4768,4769,4688,4104,4648} | Export-Csv -Path security_events.csv -NoTypeInformation
```
- Извлечь события, направленные на SPN (4769):
```powershell
Import-Csv security_events.csv | Where-Object {$_.Id -eq 4769} | Select TimeCreated, TargetUserName, ServiceName | Sort TimeCreated
```
- Конвертировать Prefetch через PECmd и фильтровать по имени/времени.

---

## Ресурсы и ссылки

- MITRE ATT&CK: Kerberoasting — T1558.003  
- Инструменты: `EvtxEcmd`, `PECmd`, `TimelineExplorer`, PowerShell `Get-WinEvent`

---

> Этот документ — воспроизводимый SOC/DFIR-плейбук для triage Kerberoasting-инцидентов. Если хотите, могу также:
> - сохранить файл как `Campfire1-Guide.md` в `/mnt/data`, или
> - экспортировать версию в DOCX для распространения.
