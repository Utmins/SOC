=====================================================================
* Введение *
************

Это пошаговое руководство, цель которой — продемонстрировать проблему, а не подробно описать атаку

Однако, дам один полезнй совет  -   если Вы застряли на каком-то этапе, так как фильтр, который Вы используете не дает нужного ответа, то просто удалите его, НО оставьте только те моменты в которых Вы полностью усовершенствованный
К примеру, Вам надо найти сервис, который был отакован скопроментированным полователем, но используемый фильтр, который вывел Вас на скопроментированного пользователя, не отображает нужную Вам информацию
Тогда, Вам надо удалить все, но оставить только index, username, soureimage (если используете), earliest/latest (если точно уверены во временном диапозоне)
И уже вычленять информацию из предоставленного результата
Более того, желательно знать значение EvenCode or EventID, но на крайний случай спросить интеренет

=====================================================================
* DCSync *
**********

DCSync — это метод, используемый злоумышленниками для извлечения хэшей паролей из контроллеров домена Active Directory (DC).
Этот метод использует разрешение Replication Directory Changes, обычно предоставляемое контроллерам домена, что позволяет им читать все атрибуты объектов, включая хэши паролей.
Члены групп Administrators, Domain Admins и Enterprise Admin или учетные записи компьютеров на контроллере домена имеют возможность выполнять DCSync для извлечения данных паролей из Active Directory.
Эти данные могут включать как текущие, так и исторические хэши потенциально ценных учетных записей, таких как KRBTGT и Administrators.

Вот как выглядит атака по шагам:

    -   Сперва злоумышленнику необходимо получить административный доступ к системе, присоединенной к домену
        Или повысить привилегии, чтобы получить необходимые права для запроса данных репликации.

    -   Затем, используя такие инструменты, как Mimikatz, злоумышленник запрашивает данные репликации домена с помощью интерфейса DRSGetNCChanges, эффективно имитируя законный контроллер домена.

            mimikatz # lsadump::dcsync /domain:<target.doamin.name> /user:<target_user> (обычно это -   krbtgt)
    
    -   После чего злоумышленник может создать «Golden Ticket»/«Silver Ticket» или использовать атаки «Pass-the-Hash/Overpass-the-Hash»

    ++++++++++++++++++++++++++++++++++
    + DCSync Detection Opportunities +
    ++++++++++++++++++++++++++++++++++

    Операции DS-Replication-Get-Changes могут быть зарегистрированы с идентификатором события Event ID 4662.
    Однако необходима дополнительная конфигурация политики аудита, поскольку она не включена по умолчанию (Конфигурация компьютера/Параметры Windows/Параметры безопасности/Расширенная конфигурация политики аудита/Доступ к DS).

    ЧТобы точно определить  -   соответствующее ли найденное событие (Event ID 4662) DS-Replication-Get-Changes, необходимо просмотреть его основные свойствах
    Если в "Properties" раздела "Operation" указано "Control Access {1131f6aa-9c07-11d1-f79f-00c04fc2dcd2}), тогда можно считать, что данное событие соответствует DS-Replication-Get-Changes, поскольку событие 4662 состоит исключительно из GUID.

    ++++++++++++++++++++++++++++++++
    + Detecting DCSync With Splunk +
    ++++++++++++++++++++++++++++++++

    Теперь давайте рассмотрим, как можно идентифицировать DCSync с помощью Splunk.

        index=main earliest=1690544278 latest=1690544280 EventCode=4662 Message="*Replicating Directory Changes*"
        | rex field=Message "(?P<property>Replicating Directory Changes.*)"
        | table _time, user, object_file_name, Object_Server, property

=====================================================================
* DCShadow *
************

DCShadow — это продвинутая тактика, используемая злоумышленниками для внесения несанкционированных изменений в объекты Active Directory, включающая создание или изменение объектов без создания стандартных журналов безопасности.
Атака использует разрешение Directory Replicator (репликация изменений каталога), обычно предоставляемое контроллерам домена для задач репликации.

DCShadow — это скрытая техника, позволяющая злоумышленникам манипулировать данными Active Directory и устанавливать постоянство в сети.
Регистрация мошеннического DC требует создания нового сервера и объектов nTDSDSA в разделе конфигурации схемы AD, что требует привилегий администратора (либо домена, либо локального по отношению к DC) или хэша KRBTGT.

Вот как выглядит атака по шагам:

    -   Сперва злоумышленнику нужно получить административный доступ к системе, присоединенной к домену
        Или повысить привилегии, чтобы получить необходимые права для запроса данных репликации.
    
    -   Затем злоумышленник регистрирует мошеннический контроллер домена в домене, используя разрешение Directory Replicator, и выполняет изменения в объектах AD,
        Например, преобразует группы пользователей в группы администраторов домена.

            a)  mimikatz # token::whoami
                Для начала злоумышленнику надо увидеть информацию о текущем токене доступа, под которым работает Mimikatz.
                Это необходимо для того, чтобы понять:

                    *   Есть ли права администратора/системы?
                    *   Работает ли Mimikatz под правильным контекстом?
                    *   Есть ли impersonation?

            b)  mimikatz # lsadump::dcshadow /object:<target_user_name> /attribute:primaryGroupID /value:512
                Потом злоумышленник "втихаря" меняет основной идентификатор группы пользователя на Domain Admins, тем самым повышая привилегии до уровня администратора домена, минуя обычный аудит.

                    *   /object:<target_user_name> 
                        Указывает имя целевого объекта в AD, например, jdoe.

                    *   /attribute:primaryGroupID
                        Имя изменяемого атрибута.
                        Этот атрибут указывает, какая группа считается основной для пользователя.

                    *   /value:512
                        Новое значение атрибута primaryGroupID.
                        Значение 512 — это RID (Relative Identifier) для группы Domain Admins.
    
    -   После чего мошеннический контроллер домена инициирует репликацию с легитимными контроллерами домена, распространяя изменения по всему домену.

            mimikatz # lsadump::dcshadow /push
    
    ++++++++++++++++++++++++++++++++++++
    + DCShadow Detection Opportunities +
    ++++++++++++++++++++++++++++++++++++

    Для эмуляции контроллера домена DCShadow должен реализовать определенные изменения в Active Directory:

        -   Добавить новый объект nTDSDSA
        -   Добавить глобальный каталог ServicePrincipalName к объекту компьютера
    
    Event ID 4742 (Computer account was changed) регистрирует изменения, связанные с объектами компьютера, включая ServicePrincipalName.

    ++++++++++++++++++++++++++++++++++
    + Detecting DCShadow With Splunk +
    ++++++++++++++++++++++++++++++++++

    Теперь давайте рассмотрим, как можно идентифицировать DCShadow с помощью Splunk.

        index=main earliest=1690623888 latest=1690623890 EventCode=4742 
        | rex field=Message "(?P<gcspn>XX\/[a-zA-Z0-9\.\-\/]+)" 
        | table _time, ComputerName, Security_ID, Account_Name, user, gcspn 
        | search gcspn=*

    Вот расшифровка ключевых моментов фильтра:

        -   search gcspn=*
            Фильтрует только те строки, в которых поле gcspn не пустое (т.е. регулярное выражение сработало).

