Event Tracing For Windows (ETW) — это универсальное высокоскоростное средство трассировки, предоставляемое операционной системой.
Используя механизм буферизации и ведения журнала, реализованный в ядре, ETW предоставляет механизм трассировки для событий, вызванных как приложениями пользовательского режима, так и драйверами устройств режима ядра.
Его архитектура облегчает динамическую генерацию, сбор и анализ различных событий, происходящих в системе, что приводит к созданию сложных журналов в реальном времени, которые охватывают широкий спектр действий.
ETW фиксирует разнообразный набор событий, охватывающих системные вызовы, создание и завершение процессов, сетевую активность, изменения файлов и реестра и множество других измерений.

Легковесность ETW и минимальное влияние на производительность делают его оптимальным телеметрическим решением для мониторинга в реальном времени и непрерывной оценки безопасности.
Выборочно включая и настраивая соответствующих поставщиков событий, мы можем точно настроить объем сбора данных в соответствии с нашими конкретными целями безопасности, достигая гармоничного баланса между богатством информации и соображениями производительности системы.

Более того, наличие надежных инструментов и утилит, включая Microsoft Message Analyzer и PowerShell's Get-WinEvent cmdlet, значительно упрощает извлечение, разбор и анализ журналов ETW.
Эти инструменты предлагают расширенные возможности фильтрации, механизмы корреляции событий и функции мониторинга в реальном времени, позволяя членам синей команды извлекать полезные сведения из обширного пула информации, собранной ETW.

    +++++++++++++++++++++++++++++++++
    + ETW Architecture & Components +
    +++++++++++++++++++++++++++++++++

    Базовая архитектура и ключевые компоненты Event Tracing for Windows (ETW) показаны на следующей схеме от Microsoft  -   https://web.archive.org/web/20200725154736/https://docs.microsoft.com/en-us/archive/blogs/ntdebugging/part-1-etw-introduction-and-overview

    В основе архитектуры ETW лежит модель публикации-подписки.
    Эта модель включает следующие основные компоненты:

        -   Controllers
            Компонент «Контроллеры», как следует из его названия, берет на себя управление всеми аспектами, связанными с операциями ETW.
            Он охватывает такие функции, как инициирование и завершение сеансов трассировки, а также включение или отключение поставщиков в рамках конкретной трассировки.
            Сеансы трассировки могут устанавливать подписки на одного или нескольких поставщиков, тем самым предоставляя поставщикам возможность начинать операции регистрации.
            Примером широко используемого контроллера является встроенная утилита «logman.exe», которая облегчает управление действиями ETW.
        
        -   Providers
            Поставщики играют ключевую роль в создании событий и записи их в назначенные сеансы ETW.
            Приложения имеют возможность регистрировать поставщиков ETW, что позволяет им создавать и передавать многочисленные события.
            Существует четыре различных типа поставщиков, используемых в ETW:

                i)      MOF Providers
                        Эти поставщики основаны на формате управляемых объектов (Managed Object Format - MOF) и способны генерировать события в соответствии с предопределенными схемами MOF.
                        Они предлагают гибкий подход к генерации событий и широко используются в различных сценариях.

                ii)     WPP Providers
                        Расшифровываются как «Windows Software Trace Preprocessor», поставщики WPP используют специализированные макросы и аннотации в исходном коде приложения для генерации событий.
                        Этот тип поставщика часто используется для низкоуровневой трассировки и отладки в режиме ядра.

                iii)    Manifest-based Providers
                        Поставщики на основе манифестов представляют собой более современную форму поставщиков в ETW.
                        Они полагаются на файлы манифестов XML, которые определяют структуру и характеристики событий.
                        Такой подход обеспечивает повышенную гибкость и простоту управления, позволяя динамически генерировать и настраивать события.

                iv)     TraceLogging Providers
                        Поставщики TraceLogging предлагают упрощенный и эффективный подход к генерации событий.
                        Они используют API TraceLogging, представленный в последних версиях Windows, который упрощает процесс генерации событий с минимальными издержками кода.
        
        -   Consumers
            Потребители подписываются на определенные интересующие их события и получают эти события для дальнейшей обработки или анализа.
            По умолчанию события обычно направляются в файл .ETL (Event Trace Log) для обработки.
            Однако альтернативный сценарий потребителя подразумевает использование возможностей API Windows для обработки и потребления событий.

        -   Channels
            Для обеспечения эффективного сбора и потребления событий ETW использует каналы событий.
            Каналы событий действуют как логические контейнеры для организации и фильтрации событий на основе их характеристик и важности.
            ETW поддерживает несколько каналов, каждый из которых имеет свою собственную определенную цель и аудиторию.
            Потребители событий могут выборочно подписываться на определенные каналы, чтобы получать соответствующие события для своих соответствующих вариантов использования.

        -   ETL files
            ETW предоставляет специализированную поддержку для записи событий на диск с помощью файлов журнала трассировки событий, обычно называемых «файлами ETL».
            Эти файлы служат надежным хранилищем событий, позволяя проводить автономный анализ, долгосрочное архивирование и судебные расследования.
            ETW обеспечивает бесперебойную ротацию и управление файлами ETL для обеспечения эффективного использования хранилища.
    
    Примечания:

        -   ETW поддерживает поставщиков событий как в режиме ядра, так и в пользовательском режиме.
        -   Некоторые поставщики событий генерируют значительный объем событий, которые могут потенциально перегружать системные ресурсы, если они постоянно активны.
            В результате, чтобы предотвратить ненужное потребление ресурсов, эти поставщики обычно отключены по умолчанию и включаются только тогда, когда сеанс трассировки специально запрашивает их активацию.
        -   В дополнение к своим собственным возможностям ETW может быть расширен с помощью пользовательских поставщиков событий.
        -   Только события поставщика ETW, к которым применено свойство Channel, могут быть использованы журналом событий

    ++++++++++++++++++++++++
    + Interacting With ETW +
    ++++++++++++++++++++++++

    Logman — это предустановленная утилита для управления Event Tracing for Windows (ETW) и Event Tracing Sessions.
    
    Этот инструмент бесценен для создания, запуска, остановки и исследования сеансов трассировки.
    Это особенно полезно при определении того, какие сеансы установлены для сбора данных, или при запуске собственного сбора данных.

    При непосредственном изучении сеанса отслеживания событий мы раскрываем конкретные сведения о сеансе, включая имя, максимальный размер журнала, местоположение журнала и подписанных поставщиков.
    Эта информация бесценна для специалистов по реагированию на инциденты.
    Обнаружение сеанса, в котором записаны поставщики, соответствующие вашим интересам, может предоставить важные журналы для расследования.

    Чтобы получить информацию о всех доступных журналах событий, использующих ETW (например, трассировки событий системы или приложений, диагностики и производительности) необходимо выполнить следующую команду:

        C\....\....\logman.exe query -ets

            )   logman.exe — это инструмент командной строки, используемый для управления журналами событий и производительности в Windows.
                Он позволяет создавать, настраивать и удалять журналы, а также выполнять другие операции с ними.
            
            )   query — это параметр, который позволяет выполнить запрос и получить информацию о существующих журналах.

            )   -ets — этот параметр указывает, что запрос должен быть сделан для журналов событий, хранящихся в Event Tracing for Windows (ETW), что представляет собой систему трассировки событий в Windows, которая используется для записи и мониторинга системных и приложенческих событий.
                Использование параметра -ets позволит проводить прямое исследование сеансов трассировки событий, предоставляя информацию о сеансах трассировки в масштабах всей системы.
    
    Обратите внимание, что параметр «-ets» имеет решающее значение для команды.
    Без него Logman не идентифицирует сеанс отслеживания событий.

    Если нам надо получить детальную информацию по конкретному журналу, то его необходимо указать после параметра "query"

        C\....\....\logman.exe query "EventLog-System" -ets

    Для каждого поставщика, подписанного на сеанс, мы можем получить критически важные данные:

        -   Name / Provider GUID
            Это эксклюзивный идентификатор поставщика.

        -   Level
            Описывает уровень события, указывая, фильтрует ли он предупреждения, информационные, критические или все события.

        -   Keywords Any
            Ключевые слова создают фильтр на основе типа события, сгенерированного поставщиком.

    Используя команду <logman.exe query providers>, мы можем сгенерировать список всех доступных поставщиков в системе, включая их соответствующие GUID.
    Windows 10 включает более 1000 встроенных поставщиков.
    Более того, стороннее программное обеспечение часто включает в себя собственных поставщиков ETW, особенно тех, которые работают в режиме ядра.
    Из-за большого количества поставщиков обычно выгодно фильтровать их с помощью findstr.
    Например, в приведенном примере вы увидите несколько результатов для «Winlogon».

        C\....\....\logman.exe query providers | findstr "Winlogon"
    
    Для отображения детальной информации по конкретному поставщику, можно воспользоваться аналогией с журналом

        C\....\....\logman.exe query providers Microsoft-Windows-Winlogon
    
    Также существуют альтернативы на основе графического интерфейса.
    Используя графический интерфейс инструмента Performance Monitor, мы можем визуализировать различные запущенные сеансы трассировки.
    Подробный обзор конкретной трассировки можно получить, просто дважды щелкнув по ней.
    Это показывает все соответствующие данные, связанные с трассировкой, от задействованных поставщиков и их активированных функций до характера самой трассировки.
    Кроме того, эти сеансы можно изменять в соответствии с нашими потребностями, включая или исключая поставщиков.
    Наконец, мы можем разрабатывать новые сеансы, выбрав категорию «Определено пользователем».

В сфере безопасности операционной системы Windows некоторые поставщики ETW считаются «ограниченными».
Эти поставщики предлагают ценную телеметрию, но доступны только процессам, имеющим необходимые разрешения.
Эта эксклюзивность призвана гарантировать, что конфиденциальные системные данные остаются защищенными от потенциальных угроз.

Одним из таких высокоценных, ограниченных поставщиков является Microsoft-Windows-Threat-Intelligence.
Этот поставщик предлагает важные сведения о потенциальных угрозах безопасности и часто используется в операциях цифровой криминалистики и реагирования на инциденты (DFIR).
Однако для доступа к этому поставщику процессы должны иметь привилегии с определенным правом, известным как Protected Process Light (PPL).

В контексте Microsoft-Windows-Threat-Intelligence преимущества этого привилегированного доступа многочисленны.
Этот поставщик может записывать высокодетализированные данные о потенциальных угрозах, позволяя специалистам по безопасности обнаруживать и анализировать сложные атаки, которые могли обойти другие средства защиты.
Его телеметрия может служить важным доказательством в криминалистических расследованиях, раскрывая подробности о происхождении угрозы, системах и данных, с которыми она взаимодействовала, и внесенных ею изменениях.
Более того, отслеживая этого поставщика в режиме реального времени, группы безопасности могут потенциально выявлять текущие угрозы и вмешиваться для смягчения ущерба