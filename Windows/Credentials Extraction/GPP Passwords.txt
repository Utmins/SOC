=====================================================================
* Руководство *
***************

Это пошаговое руководство, цель которой — продемонстрировать проблему, а не подробно описать атаку.

Атака будут выполняться с предоставленных машин Windows 10 (WS001) и Kali Linux.
Предполагается, что злоумышленник уже получил remote code execution (или что-то подобное) на этой машине Windows 10 (WS001).
Пользователь, который, как мы предполагаем, скомпрометирован, — это Боб, обычный пользователь в Active Directory без назначенных специальных разрешений.

Окружение состоит из следующих машин и соответствующих им IP-адресов:

	-	DC1		172.16.18.3
	-	DC2		172.16.18.4
	-	Server01	172.16.18.10
	-	PKI		172.16.18.15
	-	WS001		DHCP или 172.16.18.25 (в зависимости от раздела)
	-	Kali Linux	DHCP или 172.16.18.20 (в зависимости от раздела)

Если надо подключиться к любой из управляющих машин AD сервера (к примеру - DC1)

	i)		Поключаемся к хосту жертвы через RDP
	ii)		Пуск -> Windows Accessories -> Remote Desktop
	iii)		Computer	=	DC1 ip address
			User Name	=	Имя пользователя (к примеру htb-student)
	iv)		Пароль введем позже (будет предоставлен запрос)
	v)		Соглашаемся на устанвку соединения
	
=====================================================================
* Легенда *
***********

SYSVOL — это сетевой ресурс на всех контроллерах домена, содержащий сценарии входа, данные групповой политики и другие необходимые данные для всего домена.
AD хранит все групповые политики в \\<DOMAIN>\SYSVOL\<DOMAIN>\Policies\.

Когда Microsoft выпустила его с Windows Server 2008, Group Policy Preferences (GPP) представили возможность хранить и использовать учетные данные в нескольких сценариях, все из которых AD хранит в каталоге политик в SYSVOL.

В описанном ниже примере мы можем столкнуться с запланированными задачами и сценариями, выполняемыми под определенным пользователем и содержащими имя пользователя и зашифрованную версию пароля в файлах политик XML.
Ключ шифрования, который AD использует для шифрования файлов политик XML (одинаковый для всех сред Active Directory), был опубликован в Microsoft Docs, что позволяет любому человеку расшифровывать учетные данные, хранящиеся в файлах политик.
Любой может расшифровать учетные данные, поскольку папка SYSVOL доступна всем «аутентифицированным пользователям» в домене, включая пользователей и компьютеры.
Microsoft опубликовала закрытый ключ AES на MSDN	-	https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be?redirectedfrom=MSDN

Также для справки, если XML-файл, содержит зашифрованный пароль, то его значение будет расположено в разделе/строке Properties action

=====================================================================
* Схема атаки *
***************

Для злоупотребления паролями GPP мы воспользуемся функцией Get-GPPPassword из PowerSploit, которая автоматически анализирует все XML-файлы в папке Policies в SYSVOL, выбирая те, у которых есть свойство cpassword, и расшифровывая их после обнаружения
Утилиту Get-GPPPassword можно найти тут - https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1


Как было сказано ранее - злоумышленник смог создать точку проникновения в систему жертвы и может создавать удаленное подключение
В данном примере атакующая система - Kali Linux, а системы жертвы - Windows

	1)	Подключаемся к жертве через RDP

			:$ xfreerdp /u:<domain_name\\user_name> /p:<password> /v:<target_ip> /dynamic-resolution

	2)	Импортируем модуль утилиты Get-GPPPassword.ps1 (предварительно закачав ее на машину жертвы, в нашем случае в парку Downloads)

			PS C:\Users\bob\Downloads>  Import-Module .\Get-GPPPassword.ps1

		***	Как правило, в целях безопасности установлена политика НЕ запуска исполняемых файлов
			Поэтому ее надо будет обойти
			Подробную инструкцию можно найти тут	-	https://sentry.io/answers/bypass-and-set-powershell-script-execution-policies/

	3)	Тем не менее, ниже будут представленны шаги по обходу данной защитной меры

			i)		Спрева надо поерделить, какая политика запуска исполняемых файлов установлена на системе
						PS C:\...\...\> Get-ExecutionPolicy

			ii)		Если необходимо временно изменить политику (для запуска конкретного фала), то используем следующую комнаду
						PS C:\...\...\>	powershell -noexit -ExecutionPolicy Bypass -File <file_name.ps1>
			
			iii)	Если Вы хотите изменить политику на постоянной основе, то
						PS C:\...\...\>	Set-ExecutionPolicy -ExecutionPolicy <type_of_executionpolicy> -Scope <desired_scope>
			
		За более детально информацией по установке/изменению/снятию политик запуска исполняемых файлов в среде Windows	-	https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7.4#-executionpolicy

		А описание самих ExecutionPolicy и Scope можно найти тут	-	https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.5

	4)	Как только удасться снять ограничения на запуск, запускаем саму утилиту

			PS C:\Users\bob\Downloads>  Get-GPPPassword

		Имя пользователя и его пароль будут отображены на экране
		
=====================================================================
* Предотвращение/защита *
*************************

После того, как ключ шифрования был обнародован и начал использоваться не по назначению, в 2014 году Microsoft выпустила исправление (KB2962486) для предотвращения кэширования учетных данных в GPP.
Поэтому GPP больше не должен хранить пароли в новых исправленных средах.

Однако, к сожалению, существует множество сред Active Directory, созданных после 2015 года, которые по какой-то причине содержат учетные данные в SYSVOL.
Поэтому настоятельно рекомендуется постоянно оценивать и проверять среду, чтобы убедиться, что никакие учетные данные здесь не раскрыты.

Крайне важно знать, что если организация создала свою среду AD до 2014 года, скорее всего, ее учетные данные все еще кэшируются
Поскольку исправление не очищает существующие сохраненные учетные данные (только предотвращает кэширование новых).

=====================================================================
* Обнаружение *
***************

Для этой атаки есть два метода обнаружения:

	1)	Event ID 4663 - An attempt was made to access an object (попытка доступа к объекту)
	
		Доступ к XML-файлу, содержащему учетные данные, должен быть красным флагом, если мы проводим аудит доступа к файлу
		Это более реалистично относительно обнаружения, если это фиктивный XML-файл, не связанный ни с одним GPO.
		В этом случае не будет причин для кого-либо трогать этот файл, и любая попытка, скорее всего, будет подозрительной.
		
		Как показывает Get-GPPPasswords, он анализирует все XML-файлы в папке Policies.
		Для аудита мы можем генерировать событие всякий раз, когда пользователь читает файл
		После включения аудита любой доступ к файлу будет генерировать событие с идентификатором 4663

		Во время анализа событий с данным идентификатором, также рекомендуется обращать внимание на следующие полыя каждого события:
			Account Name	(in Subject Category)	-	Имя аккаунты с которого был осуществлена опытка доступа к *.xml файлу
			Object Name		(in Object category)	-	Распололжение того самого *.xml файла
	
	2)	Events: 4624 (successful logon), 4625 (failed logon), or 4768 (TGT requested).

		Попытки входа в систему (неудачные или успешные, в зависимости от актуальности пароля) пользователя, учетные данные которого раскрыты, являются еще одним способом обнаружения злоупотребления этой атакой
		Это должно генерировать одно из событий 4624 (успешный вход в систему), 4625 (неудачный вход в систему) или 4768 (запрошен TGT).

		В случае учетной записи службы мы можем сопоставить попытки входа в систему с устройством, с которого была предпринята попытка аутентификации
		Поскольку это достаточно легко обнаружить, если мы знаем, где используются определенные учетные записи (в первую очередь, если вход в систему был осуществлен с рабочей станции, что является ненормальным поведением для учетной записи службы).
		

=====================================================================
* Ловушка/Honeypot *
********************

Мы можем использовать полупривилегированного пользователя с неправильным (слабым) паролем.
Так как учетные записи служб предоставляют более реалистичную возможность, потому что:

	-	Обычно ожидается, что пароль будет старым, без недавних или регулярных изменений.
	-	Легко убедиться, что последнее изменение пароля было старше, чем при последнем изменении XML-файла GPP.
		Если пароль пользователя был изменен после изменения файла, то ни один злоумышленник не попытается войти в систему с этой учетной записью (пароль, скорее всего, больше не действителен).
	-	Планировка выполнение пользователем любой фиктивной задачи, чтобы убедиться, что были недавние попытки входа.

Когда мы делаем вышеизложенное, мы можем настроить оповещение, что если с этой учетной записью службы происходят какие-либо успешные или неудачные попытки входа, это должно быть вредоносным (предполагая, что мы вносим в белый список фиктивную задачу входа, которая имитирует активность входа в систему в оповещении).

Поскольку предоставленный пароль неверен, мы в первую очередь ожидаем неудачных попыток входа.
На это могут указывать три идентификатора событий:

	-	4625 (An account failed to log on)
			Account Name 			(in Subject category)				-	Указывает на название аккаунта, в отношении которого был испольщован неправильный пароль
			Sub Status 				(in Failure Information category)	-	Код ошибки, для использования направильного пароля = 0xC000006A
			Source Network address	(in Network Information category)	-	IP адрес атакующей машины (ну или той машины из числа корпаративных, которая была взломана для проведения этой атаки)
	-	4771 (Kerberos pre-authentication failed)
			Account Name 	(in Subject category)					-	Указывает на название аккаунта, в отношении которого был испольщован неправильный пароль
			Clietn address	(in Network Information category)		-	Указывает IP адресс атакующей (взломанной) машины
			Failure Code	(in Additional Information category)	-	Код ошибки, для использования направильного пароля = 0x18
		4776 (The computer attempted to validate the credentials for an account)
			Logon Account 	-	Указывает на название аккаунта, в отношении которого был испольщован неправильный пароль
			Error Code		-	Код ошибки, для использования направильного пароля = 0xC000006A