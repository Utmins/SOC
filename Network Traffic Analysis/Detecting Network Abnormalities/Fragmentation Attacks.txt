=====================================================================
* Руководство *
***************

Если использовать машину от HTB, то сперва надо запустить данную комнаду, чтобы скачать и распокавать все необходимые pcap файлы

	<usern_name>@<host_name>$ wget -O file.zip 'https://academy.hackthebox.com/storage/resources/pcap_files.zip' && mkdir tempdir && unzip file.zip -d tempdir && mkdir -p pcaps && mv tempdir/Intermediate_Network_Traffic_Analysis/* pcaps/ && rm -r tempdir file.zip

Удобнее всего просматривать PCAP-files используя Wireshark
Однако, в целях практики и выбработки навыков использования CLI-based tools мы будем использовать такие утилиты как tcpdump

=====================================================================
* Легенда *
***********

Когда мы начинаем искать сетевые аномалии, мы всегда должны учитывать IP layer.
Проще говоря, IP layer функционирует в своей способности передавать пакеты с одного хоста на другой.
Этот уровень использует исходные и конечные IP-адреса для межхостовых коммуникаций.
Когда мы изучаем этот трафик, мы можем идентифицировать IP-адреса, поскольку они существуют в заголовке IP пакета.

Однако важно отметить, что этот уровень не имеет механизмов для определения того, когда пакеты теряются, сбрасываются или иным образом подделываются.
Вместо этого нам нужно признать, что эти неудачи обрабатываются транспортными или прикладными уровнями для этих данных.
Чтобы разобрать эти пакеты, мы можем исследовать некоторые из его заголовков (IP packet headers):

	1)	Length (IP header length)
		Это поле содержит общую длину заголовка IP

	2)	Total Length (IP Datagram/Packet Length)
		Это поле указывает всю длину пакета IP, включая любые соответствующие данные.

	3)	Fragment Offset
		Во многих случаях, когда пакет достаточно большой для разделения, смещение фрагментации будет установлено для предоставления инструкций по повторной сборке пакета после доставки на хост назначения.

	4)	Source and Destination IP Addresses
		Эти поля содержат IP-адреса источника (источника) и назначения для двух взаимодействующих хостов.

По своей сути, злоумышленники могут создавать пакеты, чтобы вызывать проблемы со связью.
Традиционно злоумышленник может попытаться обойти контроль IDS посредством искажения или модификации пакетов.
Таким образом, погружение в каждое из этих полей и понимание того, как мы можем обнаружить их неправильное использование, даст нам инструменты для успеха в наших усилиях по анализу трафика.

В связи с этим особое внимание стоит уделять фрагментации пакетов, т.е. разделение всего пересылаемого сообщения на части.
Фрагментация служит для наших законных хостов средством передачи больших наборов данных друг другу путем разделения пакетов и их повторной сборки при доставке.
Обычно это достигается путем установки максимальной единицы передачи (MTU).
MTU используется в качестве стандарта для разделения этих больших пакетов на равные размеры для размещения всей передачи.
Стоит отметить, что последний пакет, скорее всего, будет меньше. Это поле дает инструкции хосту назначения о том, как он может повторно собрать эти пакеты в логическом порядке.

Обычно злоумышленники могут злоупотреблять этим полем для следующих целей:

	1)	Обход IPS/IDS
		Предположим, что наши средства обнаружения вторжений не собирают фрагментированные пакеты.
		Следовательно, злоумышленник может использовать свой nmap или другие методы перечисления, чтобы фрагментировать пакеты, и, таким образом, обойти эти средства управления и быть повторно собранными в месте назначения.

	2)	Обход брандмауэра
		Посредством фрагментации злоумышленник также может обойти средства управления брандмауэра.
		Опять же, если брандмауэр не соберет эти пакеты перед доставкой на целевой хост, попытка перечисления злоумышленника может быть успешной.

	3)	Истощение ресурсов брандмауэра/IPS/IDS.
		Предположим, что злоумышленник спроектировал свою атаку так, чтобы фрагментировать пакеты до очень маленького MTU (10, 15, 20 и т. д.), сетевой контроль может не собрать эти пакеты из-за ограничений ресурсов
		В следствии чего злоумышленник может преуспеть в своих усилиях по проникновению.

	4)	Отказ в обслуживании.
		Для старых хостов злоумышленник может использовать фрагментацию для отправки IP-пакетов, превышающих 65535 байт, с помощью ping или других команд.
		При этом целевой хост соберет этот вредоносный пакет и столкнется с бесчисленным множеством различных проблем.
		Таким образом, результирующим условием является успешный отказ в обслуживании от злоумышленника.

=====================================================================
* Подготовка *
**************

Как такового, подготовительного этапа, не существует
Однако если мы хотим, чтобы наш сетевой механизм работал правильно, мы должны выполнить следующие минимальные настройки/установки:

	-	Delayed Reassembly (Отложенная сборка)
		IDS/IPS/брандмауэр должен действовать так же, как и целевой хост, в том смысле, что он ждет прибытия всех фрагментов, чтобы восстановить передачу и выполнить проверку пакетов.

=====================================================================
* Анализ *
**********

Одним из "красных флагов" явялется еобычное количество и характер ICMP-запросов, идущих к одному хосту от другого
Это указывает на начальные запросы от традиционного сканирования Nmap.
Это начало процесса обнаружения хоста.

Как правило, генерация такого трафика вызвана следующей командой, запущенной злоумышленником

	<user_name>@<host_name>$ nmap <target_ip>

Затем, злоумышленник может определить максимальный размер единицы передачи, чтобы фрагментировать свои пакеты сканирования портов.

	<user_name>@<host_name>$ nmap -f 10 <target_ip> 

Как видно из команду пакеты/запросы будут генерировать IP-пакеты с максимальным размером 10.
Поэтому, выявления за большого количества ICMP-запросов с одинаковой длиной (lenght) пакета/кадра от хоста одного и того же может быть индикатором такой атаки

Однако более заметным показателем атаки с фрагментацией пакетов, независимо от использования способов уклонения, являются запросы от одного хоста на множество портов, которые оно генерирует.
В этом случае хост назначения будет отвечать флагами RST для портов, на которых не запущена активная служба (т. е. закрытые порты).
Этот шаблон является явным признаком фрагментированного сканирования.

***	Если Ваш Wireshark не собирает пакеты для проверки, Вы можете быстро изменить настройки для протокола IPv4.

=====================================================================
* Дополнительные Вопросы *
**************************

	Опредлеите общее количество пакетов, имеющих флаг TCP RST

		-	tcp.flags.reset==1
