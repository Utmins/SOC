`=====================================================================
* Руководство *
***************

Если использовать машину от HTB, то сперва надо запустить данную комнаду, чтобы скачать и распокавать все необходимые pcap файлы

	<usern_name>@<host_name>$ wget -O file.zip 'https://academy.hackthebox.com/storage/resources/pcap_files.zip' && mkdir tempdir && unzip file.zip -d tempdir && mkdir -p pcaps && mv tempdir/Intermediate_Network_Traffic_Analysis/* pcaps/ && rm -r tempdir file.zip

Удобнее всего просматривать PCAP-files используя Wireshark
Однако, в целях практики и выбработки навыков использования CLI-based tools мы будем использовать такие утилиты как tcpdump

=====================================================================
* Легенда *
***********

По сути, когда злоумышленники получают информацию о наших TCP-сервисах, мы можем заметить достаточно странный поток пакетов во время анализа трафика.

Однако, сперва стоит вспомнить, как работают обычные TCP-соединения с их трехсторонним рукопожатием

	1)	Чтобы инициировать TCP-соединение для любой цели, клиент сначала отправляет хосту, к которому он пытается подключиться, запрос TCP SYN для начала TCP-соединения.

	2)	И если этот порт открыт и к нему действительно можно подключиться, машина отвечает TCP SYN/ACK, чтобы подтвердить, что соединение действительно и может быть использовано.
		Однако мы должны учитывать все флаги TCP:

			-	URG (urgent/срочно)
				Этот флаг обозначает срочность с текущими данными в потоке.

			-	ACK (acknowledgement/подтверждение)
				Этот флаг подтверждает получение данных.

			-	PSH (push/отправка)
				Этот флаг указывает TCP-стеку немедленно доставить полученные данные на прикладной уровень и обойти буферизацию.

			-	RST (reset/сброс)
				Этот флаг используется для завершения TCP-соединения.

			-	SYN (synchronize/синхронизация)
				Этот флаг используется для установления начального соединения с TCP.

			-	FIN (finish/завершение)
				Этот флаг используется для обозначения завершения TCP-соединения.
				Он используется, когда больше не нужно отправлять данные.

			-	ECN (explicit congestion notification/уведомление о перегрузке)
				Этот флаг используется для обозначения перегрузки в нашей сети, он должен дать знать хостам, чтобы избежать ненужных повторных передач.

	3)	После чего хост отправляет подтверждение/согласие TCP ACK, что данный порт будет использоваться

Таким образом, при выполнении анализа трафика, для выявления потенциально-опасных подключния нас следует обращать внимание на следующие странные условия:

	i)		Слишком много флагов одного или нескольких типов
			Это может указывать на то, что в нашей сети происходит сканирование.

	ii)		Использование разных и необычных флагов
			Иногда это может указывать на атаку TCP RST, перехват или просто на какую-то форму уклонения от контроля при сканировании.

	iii)	Запросы от одного хоста на несколько портов или от одного хоста на несколько хостов
			
=====================================================================
* Подготовка *
**************

Как такового, подготовительного этапа, не существует
Однако для фильтрации пакетов согласно установленным флагам, использую следующий фильтр

	-	tcp.flags.<flag_name>==#

			<flag_name>	-	название флага.
						Если вы не знаете, как флаг указан в системе фильтрации Wireshark, то как только Вы введете tcp.flags. система автоматически предоставит Вам выпадаюший список всех доступных флагов

			#		-	указывате, используется ли данный флаг (1) или не используется (0)

=====================================================================
* Анализ *
**********

	+++++++++++++++++++++++
	+ Excessive SYN Flags +
	+++++++++++++++++++++++

	Одина из наиболее часто встречающихся атак, которую можно легко заметить — это слишком много флагов SYN.
	​​Это яркий пример сканирования nmap.
	Проще говоря, злоумышленник отправит пакеты TCP SYN на целевые порты.
	В случае, если наш порт открыт, наша машина ответит пакетом SYN-ACK для продолжения рукопожатия, на который затем будет отправлен RST от сканера злоумышленников.
	Однако здесь мы можем запутаться в RST, поскольку наша машина ответит RST для закрытых портов.

	В реальности это выгляит как последовательнй поток пакето(запросов) от одного IP и одного Port# на один IP жертвы, но разные Port#
	И среди этого потока будут проскакивать RST, ACK акеты, отправленные отбратно с IP жертвы (как правило будет выделен красным, так как является подозрительным)

 	В связи с этим стоит отметить, что есть два основных типа сканирования, которые мы можем обнаружить, которые используют флаг SYN:

		i)	SYN-сканирование
			При этих сканированиях поведение будет таким, что злоумышленник заранее завершит рукопожатие с помощью флага RST.

		ii)	SYN-скрытое сканирование
			В этом случае злоумышленник попытается избежать обнаружения, лишь частично завершив TCP-рукопожатие

	++++++++++++
	+ No Flags +
	++++++++++++

	Также, злоумышленник может вообще не устанавливать какие-либо флаги.
	Это то, что обычно называют сканированием NULL.
	При сканировании NULL TCP-соединения ведут себя следующим образом при получении пакета NULL.

		-	Если порт открыт — система вообще не ответит, так как флагов нет.

		-	Если порт закрыт — система ответит пакетом RST.

	+++++++++++++++++
	+ Too Many ACKs +
	+++++++++++++++++

	Еще один из вариантов атак, которое мы можем с легкостью заметить - чрезмерное количество подтверждений между двумя хостами.
	В этом случае злоумышленник может использовать сканирование ACK.
	В случае сканирования ACK TCP-соединения будут вести себя следующим образом.

		-	Если порт открыт — затронутая машина либо не ответит, либо ответит пакетом RST.

		-	Если порт закрыт — затронутая машина ответит пакетом RST.

	++++++++++++++++++
	+ Excessive FINs +
	++++++++++++++++++

	Используя одну из частей рукопожатия, злоумышленник может использовать сканирование FIN.
	В этом случае все пакеты TCP будут помечены флагом FIN.
	Поведение жертвы будет выглядеть следующим образом:

		-	Если порт открыт — жертва просто не будет отвечать.

		-	Если порт закрыт — жертва ответит пакетом RST.

	+++++++++++++++++++++++++++++++
	+ Just too many flags (X-MAS) +
	+++++++++++++++++++++++++++++++

	Злоумышленник может захотеть "все и сразу"
	В этом случае он может использовать сканирование Xmas tree, когда он устанавливает все флаги TCP на свои передачи.
	Следовательно, жертва может ответить следующим образом, когда установлены все флаги:

		-	Если порт открыт — жертва не ответит или, по крайней мере, ответит пакетом RST.

		-	Если порт закрыт — жертва ответит пакетом RST.

=====================================================================
* Дополнительные Вопросы *
**************************
